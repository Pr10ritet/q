<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - Работа с биллингом</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>

<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Работа с биллингом</b></td>
</tr></table>

<br>
<ul>
<li><a href="descr.html">Детали системы</a></li>
<li><a href="#toadm">Доступ к админке</a></li>
<li><a href="priv.html">Система привилегий администратора</a></li>
<li><a href="priv.html#auth">Авторизация в админке</a></li>
<li><a href="#new">Создание учетной записи клиента</a></li>
<li><a href="#edit">Изменение данных клиента</a></li>
<li><a href="#dopdata">Дополнительные данные клиента</a></li>
<li><a href="#lists">Работа со списком клиентов</a></li>
<li><a href="#pays">Платежи</a></li>
<li><a href="#paysopt">Опциональные платежи</a></li>
<li><a href="tarifs.html">Тарификация трафика</a></li>
<li><a href="#month">Закрытие месяца</a></li>
<li><a href="#del">Удаление клиента</a></li>
<li><a href="#alias">Клиенты, имеющие несколько ip-адресов</a></li>
<li><a href="#block">Блокировка доступа</a></li>
<li><a href="#minus">Проблема "ухода в минус"</a></li>
<li><a href="#card">Карточки пополнения счета</a></li>
<li><a href="#mail">Почта</a></li>
<li><a href="maps.html">Топология</a></li>
<li><a href="equipment.html">Оборудование</a></li>
<li><a href="#job">Задания работникам</a></li>
<li><a href="#stat">Клиентская статистика</a></li>
<li><a href="#ermess">Сообщения об ошибках</a></li>
<li><a href="nomake.html">Выдача ip-адресов по DCHP</a></li>
<li><a href="#backup">Бекап</a></li>
<li><a href="payterm_osmp.html">Модуль платежных терминалов ОСМП</a></li>
</ul>
<a name="toadm"><div class="coment" align=center><b>Доступ к админке</b></div></a></br>
<br>
Доступ к управлению NoDeny осуществляется через браузер:<br>
<br>
<em>https://server/cgi-bin/adm/adm.pl</em><br>
<br>
где <em>server</em> - имя или ip сервера с установленной админкой.<br><br>
<br>
<a href="#eraccess">Ошибки доступа к админке</a><br>
<br>
<br>
<br>




<div class="coment" align=center><b><a name="new">Создание учетной записи клиента.</a></b></div><br>
В верхнем меню админки выбираем &#171;Операции&#187;, затем &#171;Новый клиент&#187;.<br>
<br>
При занесении нового клиента система автоматически устанавливает состояние клиентской записи &#171;На подключении&#187;.
Такой клиент будет выделяться в списке клиентов, также при применении фильтра &#171;вывести всех на подключении&#187;
будет выведен список клиентов в этом состоянии, отсортированный по дате занесения договора (более старые вверху).
Существует 2 состояния &#171;на подключении&#187;. Второе именуется как &#171;На подключении, настроить&#187;.
Заметим, что состояния рекомендованы исходя из опыта работы нескольких сетей и не
навязываются. Вы можете их игнорировать. Тем не менее, рекомендованная схема работы: клиент вносится в базу данных,
устанавливается (автоматически) состояние &#171;на подключении&#187;, вносятся комментарии (когда подключить,
проблемы и т.д), при подключении переводят клиента в состояние &#171;На подключении, настроить&#187;. При появлении трафика
либо первой авторизации, клиент автоматически выводится из состояния &#171;на подключении&#187; и удаляется комментарий,
относящийся к подключению. Состояние &#171;настроить&#187; отличается от состояния &#171;На подключении, настроить&#187; тем,
что первое нужно давать только уже работающим клиентам.<br>
<br>
При создании данных клиента, также автоматически устанавливается значение параметра &#171;день начала потребления услуг&#187;
в -1 (минус один). Этот параметр регулирует ситуацию, когда новый клиент начинает работать не с первого числа месяца,
таким образом ему следовало бы создать персональный пакет пропорциональный количеству дней, которые он потребляет услуги.
Например, логично было бы клиенту, подключившемуся в последний день месяца, выдать пакет с предоплаченным
трафиком и стоимостью в 30 раз меньшими чем оригинальный пакет. Как только клиент произведет первую авторизацию
или получит 1й байт входящего трафика, параметр &#171;день начала потребления услуг&#187; будет установлен в значение
дня текущего месяца и для него будет &#171;создан&#187; виртуальный пакет с данными, пропорциональными количеству оставшихся
дней в месяце. С наступлением нового месяца у всех клиентов (кроме тех, кто не начал пользоваться услугами)
&#171;день начала потребления услуг&#187; устанавливается в ноль, что будет отключать &#171;создание&#187; виртуального пакета.<br>
<br>
Имеется возможность группировать несколько учетных записей (например, у клиента несколько компьютеров) в одну, при
этом одна запись будет именоваться основной, а остальные - алиасными. Для добавления алиасных записей вам необходимо
открыть данные основной записи и выбрать пункт &#171;добавить алиас&#187;. Читайте <a href="#alias">о клиентах, имеющих несколько
ip-адресов.</a>
<br>
<br>
<em>Группа</em> - для удобства администрирования следует группировать клиентов. Например, удобно
создать группы &#171;Администраторы&#187;, &#171;сервера&#187; и ограничить к ним доступ обычным администраторам. Создать группу
&#171;Удаленные&#187; и перемещать в эту группу клиентов, разорвавших контракты, - это лучше удаления т.к за такими
клиентами ведется финансовая история, сохраняются их адреса и т.д, при спорных вопросах или при переподключении
всегда можно будет восстановить данные. Группы задаются в настройках.
<br>
<br>
При выборе ip адреса для клиента можете воспользоваться системой выдачи ip адресов, которая в зависимости
от вашей топологии (сегментации) выдаст первый незанятый ip адрес для заданного адреса подключения. Для
использования этой системы необходимо <b>предварительно</b> заполнить раздел <b>[топология]</b>. В
этом разделе указываются точки подключения  (например ящики с оборудованием) и их адреса. Каждая точка
может иметь свой диапазон ip адресов (либо несколько точек имеют один диапазон). Диапазон указывается
с начального ip и заканчивается адресом xx.xx.xx.254. При выборе нужной улицы и дома будет предложен
самый нижний (начиная с начального) незанятый ip адрес, если по нему щелкнуть, то он автоматически занесется
в поле &#171;ip адрес&#187;:<br><br>
<img src='../i/p22.gif'><br><br>
<br>
<br>
Кроме того, предусмотрен механизм контроля допустимости ip-адреса для определенной группы клиентов - в настройках
группы можно задать список подсетей, из которых разрешено выдавать ip клиентам группы. Этот механизм
исключает ошибки, когда клиенту в определенном районе назначается ip-адрес, не смаршрутизированный
на маршрутизатор этого района.<br>
<br>
Клиент внесен в базу данных, через некоторое время (в настройках биллинга &#171;время
обновления информации о пользователях из базы данных&#187;) он уже сможет иметь доступ в
интернет.<br>
<br><br>



<div class="coment" align=center><b><a name="edit">Изменение данных клиента</a></b></div><br>
Перейдите в раздел &#171;Клиенты&#187; и выберите в списке нужного клиента - щелкните по ссылке в виде его логина.
Вы попадете на страницу редактирования данных клиента.
<br><br>
В зависимости от привилегий администратора многие функции могут быть недоступны и не отображаться
некоторые поля.<br>
<br>
Учтите, что любые изменения данных клиентов производятся в базе, которую периодически
перечитывает ядро NoDeny (<em>nodeny.pl</em>). Т.о. если вы измените пароль клиента, либо пакет,
либо запретите/разрешите доступ клиенту, изменения не проявятся мгновенно - должно пройти время
перечитывания списка клиентов серверной частью (время указывается в настройках, рекомендовано 5 минут).
Для ускорения вы можете послать сигнал перечитывания списка клиентов (если у вашего логина есть на это права).
<br>
<br><br>
Информация о каждом измененном поле данных клиента регистрируется в таблице платежей как событие. Таким
образом сохраняется хронология событий с регистрацией измененных данных, даты изменения, администратора
внесшим изменения.
<br>
<br><br>


<div class="coment" align=center><b><a name="dopdata">Дополнительные данные клиента</a></b></div><br>
Данные учетных записей клиентов делятся на 2 типа:<br>
<br>
- обязательные;<br>
- необязательные.<br>
<br>


К первому типу относятся такие данные, как логин, баланс, пакет тарификации и др. С другой стороны,
в каждой сети могут быть свои требования по хранению иных параметров, например, необходимо 
регистрировать паспортные данные на каждого клиента. Таких дополнительных данных у каждой сети
может быть множество. Поэтому NoDeny предлагает механизм гибкого управления этими данными,
которые именуются как дополнительные.<br>
<br>

Дополнительные данные - это набор заранее запрограммированных полей, каждое из которых имеет свой тип.
Набор полей носит название &#171;шаблон дополнительных данных&#187;, шаблоны задаются в главных настройках.
Примером часто используемого шаблона является &#171;адрес&#187;. Ранее поля адреса были обязательными,
были фиксированного количества и имели статические названия. Такими полями были: улица, дом, квартира, этаж.
Очевидно, что некоторым организациям этого списка будет недостаточно - им нужны поля "блок дома", "подъезд",
а некоторым  даже поле "город". NoDeny предоставляет возможность указать свой список полей, исключив
ненужные и добавив необходимые.<br>
<br>

По умолчанию при инсталляции некоторые поля шаблона &#171;адрес&#187; (улица, дом, блок, подъезд, этаж,
квартира, телефон, комментарий) будут созданы автоматически. Для того, чтобы добавить или исключить поля
адреса, необходимо зайти в меню &#171;Операции&#187; &rarr; &#171;Настройки&#187; &rarr;
 &#171;Дополнительные поляв&#187;. Должен отобразиться список полей: к какому шаблону они относятся
(в нашем случае это &#171;адрес&#187;), название и тип. Тип поля может принимать одно из следующих значений:<br>
<br>

- целое;<br>
- целое положительное;<br>
- вещественное;<br>
- вещественное положительное;<br>
- строковое однострочное;<br>
- строковое многострочное;<br>
- да/нет;<br>
- привязка к объекту;<br>
- выпадающий список;<br>
- пароль.<br>
<br>

К примеру, у поля &#171;номер дома&#187; тип &#171;целое положительное&#187;. Если же в вашем городе существуют
не цифровые дома, то вы можете поменять тип на строковый. Вы можете добавить строковое поле &#171;город&#187;.<br>
<br>

Кроме типа, у поля есть название и алиас. Название отображается администратору в процессе работы. Например,
вы можете переименовать поле &#171;квартира&#187; в &#171;кабинет&#187;, если ваша сеть - госучереждение.<br>
<br>

Алиас - это внутреннее название поля. Алиас позволяет NoDeny понять назначение данного поля. Все дополнительные
данные для NoDeny - это куча безликой информации. Чтобы NoDeny понял, что поле представляет собой номер дома,
алиас необходимо выставить в значение &#171;_adr_house&#187;. Вообще, алиас необязателен к заполнению.
Однако, если вы хотите осуществлять поиск по адресу, то желательно полям прописать алиасы:<br>
<br>

<table border=1>
<tr><td>Улица	</td><td>p_street:street:name_street</td></tr>
<tr><td>Дом	</td><td>_adr_house		</td></tr>
<tr><td>Блок	</td><td>_adr_block		</td></tr>
<tr><td>Подъезд	</td><td>_adr_front_door	</td></tr>
<tr><td>Этаж	</td><td>_adr_floor		</td></tr>
<tr><td>Квартира</td><td>_adr_room		</td></tr>
<tr><td>Телефон </td><td>_adr_telefon		</td></tr>
</table>
<br>
<br><br>
<br><br>


<a name="pays"><div class="coment" align=center><b>Платежи</b></div></a>
<br>
Виды платежей:<br>
<br>
- безналичные;<br>
- наличные;<br>
- опционные;<br>
- временные.<br>
<br>
Как не трудно догадаться, платежи непосредственно влияют на баланс клиента. Сумма всех проведенных платежей
(пополнения счета, снятия за услуги, бонусные начисления и т.д.) и есть баланс клиента. Кроме этого, баланс
хранится непосредственно в учетной записи клиента. Доверенному администратору могут быть выданы права на
редактирование баланса с исключительных случаях, в реальности которые практически никогда не потребуются
(по крайней мере, автор в своей сети никогда не использовал эту возможность). То есть все управление
балансом клиента идет через платежи, которые могут быть проведены как администратором так и автоматически,
например, при пополнении счета через карточку пополнения.<br>
<br>
Важной характеристикой платежа является признак наличности или безналичности. Этот признак предназначен строго
для отчетности, поскольку позволяет быть 100%-но информированным сколько у какого администратора/реализатора
наличности &#171;на руках&#187;.<br>
<br>
В связи с этим важно четко запомнить всего одно простое правило: <em>Если администратор принимает/отдает
реальные (наличные) деньги - это считается наличным платежом</em>.<br>
<br>
Например, получение наличных денег от клиента при подключении, пополнении счета, возврат наличных,
выдача зарплаты, покупка оборудования, материалов - наличные платежи.<br>
<br>
Снятия за услуги (интернет, дополнительный Ip адрес, настройка, стоимость подключения), премирование,
штрафы, перевод с другого счета, перевод на другой счет, банковский перевод, пополнение через карточки
пополнения счета - это все безналичные платежи, поскольку деньги не проходят через руки администратора,
проводящего платеж.<br>
<br>
Придерживаясь порядка в платежах, т.е устанавливая галочку нал/безнал при их проведении,
вы всегда сможете проконтролировать наличность на руках у каждого администратора в любой момент времени.<br>
<br>
Примеры. Как следует поступать при подключении клиента к сети:<br>
<br>
Допустим, стоимость подключения 150 грн. Клиент подписывает договор и платит наличностью 200 грн
чтобы 50 грн сверх 150 были на счету для дальнейших оплат услуг. Администратор, принимающий наличность,
проводит 200 грн без признака &#171;безнал&#187; на счет клиента. После чего проводит безналичный платеж
&#171;-150 грн&#187; и в комментарии для клиента указывает &#171;стоимость подключения&#187;.<br>
<br>
После таких операций, по отчетности, на счету абонента будет 50 грн, а &#171;на руках&#187; администратора 200 грн.<br>
<br>
Далее, выясняется, что клиент подключился по совету своего соседа, а, допустим, по правилам сети, мы обязаны
премировать таких людей. Проводим на соседа безналом, к примеру, 30 грн и в комментариях указываем
&#171;премия за приведенного клиента такого-то&#187;.<br>
<br>
Клиент попросил вас установить ему на компьютер Linux, за это вы договорились снять со счета клиента
100 грн в оплату за эту услугу. Т.к. реальной передачи денег не произошло, то при внесении значения
&#171;-100&#187; (минус 100) нужно ставить галочку &#171;безнал&#187;, благодаря чему счет клиента уменьшится на
100гр, но состоянии кассы не изменится. В дальнейшем пользователь вносит наличные и задолженность
погашается. Так же рекомендуется в поле &#171;комментарий&#187; сделать пометку, например &#171;за установку Linux&#187; -
пользователь при просмотре своей статистики будет видеть за что с него были сняты деньги.<br>
<br>
Все денежные операции, касающиеся сети, но не касающиеся клиентов напрямую, должны быть осуществлены
через пункт &#171;Затраты сети&#187;. Например, плата вышестоящему провайдеру за канал в интернет,
затраты на покупку оборудования, финансирование предприятия и т.д.
Все эти действия должны оказывать влияние на кассу. Зарплаты рекомендуется проводить
через пункт &#171;зарплаты работникам&#187; для более удобного получения статистики. Если вы не используете модуль
&#171;работники&#187;, можете проводить зарплаты как затраты сети.<br>
<br>
При просмотре списка платежей вы можете отредактировать/удалить любой платеж (если есть права).
Для этого нажмите на &#171;&rarr;&#187; в последней колонке напротив соответствующего платежа.
После редактирования платеж помечается как редактированный - указывается время
и администратор изменивший запись. Администратор с соответствующими привилегиями может убирать такие пометки.<br>
<br>
Редактирование платежей относительно небезопасная операция, поскольку нет 100%-й гарантии лояльности
работников, проводящих платежи - возможно отредактировать платежи, проведенные ранее и таким образом изменить
баланс клиента так, чтобы это не было заметно. С другой стороны никто не застрахован от ошибок, поэтому рекомендуем
использовать удобную возможность: в правах администратора разрешить редактировать только свои платежи и только если
время их проведения не старше чем 10 минут от момента редактирования.<br>
<br>
Если у вас работает(ют) человек, принимающий платежи, то в момент забора наличных у него необходимо оформлять передачу денег
между администраторами (кнопка &#171;передача наличных&#187;). Т.о вы можете контролировать сколько наличных на руках у каждого
из администраторов.<br>
<br>
<em>Временные платежи</em> позволяют временно разрешить доступ в интернет клиенту. Например, у клиента
отрицательный баланс в 200 рублей, он звонит и сообщает, что имеет возможность заплатить только через
неделю. В таком случае удобно не убирать границу отключения (или ее понижать), а осуществить
временный платеж в 200 рублей сроком 7 дней. Через 7 дней платеж удалится автоматически и клиент
будет автоматически заблокирован если не сдержал свое обещание. Какие плюсы таких платежей:<br>
<br>
- нет необходимости контролировать клиента, это делается автоматически в заданное количество дней;<br>
- нет необходимости понижать границу отключения, поскольку можно забыть поднять ее впоследствии;<br>
- ведется история по временным платежам;<br>
- в клиентской статистике абонент видит сообщение о том, что у него временный платеж и что неплохо-бы заплатить за услуги.<br> 
<br>
Запомните - временные платежи безопасны - они гарантированно будут удалены системой в любом случае.<br>
<br>
Временный платеж может быть отрицательным - имеет смысл для случая &#171;наказание лишением доступа в интернет на Х суток&#187; -
после удаления отрицательного платежа баланс станет положительным и доступ будет разрешен.<br>
<br>
В особых случаях (регулируется привилегиями) платеж можно провести &#171;задним числом&#187; для решения конфликтов с клиентами из-за
невовремя внесенных платежей.<br>
<br>
<br>





<a name="paysopt"><div class="coment" align=center><b>Опциональные платежи</b></div></a><br>
<br>
Опциональные платежи - платежи, которые активируются клиентом самостоятельно через клиентскую
статистику и позволяют за дополнительную плату улучшить некоторые условия тарифного плана.
Реализованы улучшения двух типов:<br>
<br>
- модификатор скорости: повышение скорости на определенный (оплаченный) период времени для определенного класса трафика;<br>
- модификатор трафика: покупка дополнительного предоплаченного количества трафика для определенного пакета.<br>
<br>
Первый тип обычно используется для тарифов, в которых указано ограничение по скорости, например для анлимов.<br>
<br>
Опциональный платеж имеет обязательное свойство - срок действия, причем привязка к границе месяца отсутствует -
опцию можно активировать в любой день в любое время. Таким же образом действие пакета может закончится в любой
день месяца, в зависимости от срока действия, который  может быть любым от нескольких минут до 60 дней.<br>
<br>
По окончанию периода действия опции, &#171;улучшения&#187; активированные данной опцией, прекращают свое действие,
вне зависимости от того использован ли выделенный трафик либо же нет.<br>
<br>
Тип модификатора (по скорости либо по трафику) определяется трафиком, который указан в опции: если трафик
отрицательное число, то на это количество мегабайт уменьшится трафик клиента (определенного направления).
При этом если результирующий трафик окажется отрицательным числом - это совершенно нормальное явление и
означает &#171;запас трафика&#187;. Если число, указанное в опции, положительное - это модификатор скорости.
Модификатор скорости действует только в пределах выделенного трафика. например, можно создать такую опцию:<br>
<br>
<em>Доступ к ресурсам video.xx.xx и mp3.xx.xx на неограниченной скорости. Лимиты: срок действия 10 дней либо
использование 15 Гб трафика данных ресурсов</em><br>
<br>
Действие этой опции следующее. Клиент, имеющий тарифный план, скажем, unlim 512k, может в
любой день активировать опцию при условии остатка на балансе не менее стоимости опции, а также при отсутствии
временных платежей. После этого, для направления, описывающего ресурсы video.xx.xx и mp3.xx.xx, снимаются
лимиты по скорости на срок 10 дней от текущего момента времени (с учетом часа и минут). Как только клиент
потребит 15Гб трафика данных ресурсов, скорость вернется в прежнее (512k) значение. Если же клиент
не потребит весь трафик, то через 10 дней действие опции в любом случае закончится.<br>
<br>
Лимиты по трафику могут отсутствовать, тогда улучшение будет заключаться в повышении скорости на определенный
период времени без учета трафика.<br>
<br>
Возможно активировать несколько опций несколько раз в месяц, однако невозможно активировать опцию, которая уже активна -
срок действия которого не закончен либо же не выработан опциональный трафик.<br>
<br>
Для каждого тарифного плана может быть разрешен свой список опций. Для некоторых тарифов можно отключить опции
полностью.<br>
<br>
Имеется возможность создания &#171;пака опций&#187; - активировать сразу несколько опций за определенную цену, меньшую чем
суммарной стоимости входящих опций.<br>
<br>
<br>
<br>

<div class="coment" align=center><b><a name="lists">Работа со списком клиентов</a></b></div><br>
<br>
Одной из наиболее частых операций, производимых администраторами, несомненно является нахождение клиента
по заданным критериям. Для удобства, строка поиска присутствует на всех страницах NoDeny в верхнем меню справа
- поле ввода, поиск по значению которого активизируется но нажатию клавиши enter.<br>
<br>
Удобство поиска обеспечивается адаптивностью под вводимые данные. Вы можете ввести имя, фамилию или их фрагмент,
если клиент произнес невнятно по телефону, логин, ip, фрагмен ip или подсеть, адрес подключения.<br>
<br>
По умолчанию производится поиск по ФИО, однако дополнительно выводится количество записей, попадающих под поиск
по каждому критерию. Так при поиске строки &#171;27.50&#187; будут выведены ip адреса, которые оканчиваются на
27.50, будут выведены адреса подключения, у которых дом 27 и квартира 50, логины в которых присутствует строка
&#171;27.50&#187;. Дополнительное удобство обеспечивается автоматической транслитерацией, т.е. вы можете ошибиться в
раскладке клавиатуры и ввести, скажем, &#171;bdfyjd&#187;. NoDeny произведет транслитерацию в &#171;иванов&#187; и
выдаст результат для этой строки. Дополнительные преобразования покажем на примере, ввод: &#171;12ю77&#187; или
&#171;12/77&#187; найдет ip, попадающие под шаблон хх.хх.12.50, а также записи с адресом подключения дом 12 кв. 77.
Ввод: 10.1.2. - будут найдены ip, попадающие под шаблон 10.1.2.xx. Ввод: 10. - 10.хх.хх.хх.<br>
<br>

На странице &#171;клиенты&#187; присутствует дополнительное поле поиска по дому и/или квартире. В нем можно указывать
сокращенное название улицы. Например, введя &#171;до108&#187;, будут найдены все клиенты в домах 108 по улицам, названия
которых начинаются с &#171;до&#187;.<br>
<br>



<img src='../i/p1.gif'><br><br><br>
На скриншоте видно:<br><br>
В таблице со списком клиентов, в первой колонке отображается состояние авторизации в данный момент:<br>
- если нет ключика - клиент не авторизован;<br>
- если ключик зеленый - клиент авторизован и доступ в инет разрешен;<br>
- если ключик желтый - клиент авторизован и доступ разрешен только в подсети класса 2 (например, только городские);<br>
- если ключик серый - клиент авторизован и доступ в инет закрыт самим клиентом;<br>
- если ключик красный - клиент авторизован и доступ в инет заблокирован, причину блокировки можно узнать подведя
 курсор к ключику;<br>
<br><br>
В следующей колонке отображается ip и логин клиента, а также если есть - его алиасные записи. На одной учетной записи можно оганизовать несколько алиасных учетных записей для разных компьютеров либо даже для разных физических лиц.  Адреса, под
которыми авторизован клиент, выделяются. <br><br>
В колонке трафика может быть один или два числа в зависимости от пакета клиента. 
Это значения: &#171;направление 1&#187; и &#171;направление 2&#187; (названия направлений задаются в настройках).<br><br>
В колонке &#171;баланс начало месяца&#187; указывается текущий баланс клиента без учета снятия за потребленные услуги в этом месяце.<br><br>
В последней колонке указывается баланс с учетом снятия за месяц. Также может указываться граница, при балансе ниже
которой доступ в интернет будет заблокирован автоматически.<br><br>
При нажатии на кнопку в столбце балансов  будут показаны только те клиенты, у которых отрицательный баланс
<br><br>
Нажатие на кнопку [+] слева от учетной записи клиента, приводит к выводу дополнительных кнопок для осуществления
операций над данной учетной записью (пополнение счета, показ абонента на карте, группировка по дому, точке подключения,
выдача задания работникам)
<br><br>
При нажатии на кнопку &#171;адрес&#187; произойдет группировка клиентов по улице, дому и сортировка квартир по возрастанию.
Удобно если ip-адреса присваиваются в разброс. Также в этом режиме наглядно выводится информация о &#171;спаренных&#187; клиентах - 
есть сети практикующие два стомегабитных подключения на 8-жильную витую пару.
<br><br>
Если учетной записи доступ заблокирован, то ее фон красного цвета. Если красного цвета только фон участка с трафиком,
то запись заблокирована не полностью - только доступ в интернет (это регулируется пакетом тарификации - должен
быть установлен параметр &#171;блокировать при выработке предоплаченного трафика&#187;)
<br>
<br>
<br>



<a name="month"><div class="coment" align=center><b>Закрытие месяца</b></div></a><br>
Расчетный период системы NoDeny - месяц. C 1 по 31 число происходит накопление трафика в учетной записи клиента,
после чего вступает в действие новый тарифный план, для которого необходимо трафик учитывать с нуля, поэтому при
наступлении нового месяца, должны быть выполнены следующие действия:<br> 
<br>
- формирование платежа-снятия согласно пакета тарификации клиента и потребленного им трафика;<br>
- запись данных в архив;<br>
- обнуление текущего трафика;<br>
- перевод клиентов на заказанные пакеты.<br>
<br>
Эти действия выполняет скрипт &#171;перехода на новый месяц&#187; <em>new_month.pl</em>.
<b>Вы должны прописать автоматический запуск <em>new_month.pl</em> в начале каждого месяца, например,
1го числа в 00:00, но никак не в конце - к примеру, 31го числа в 23:59 нельзя.</b> Автоматический запуск
можно оформить через crontab:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
server_www# cd /usr/local/nodeny
server_www# ee crontab.txt
</pre>
</div>

и введите:<br>
<br>

<div class='code'><div class='mark'>Редактирование файла crontab.txt</div><pre>
0   0     1    *     *    /usr/bin/perl /usr/local/nodeny/new_month.pl
</pre>
</div>


Поставьте crontab.txt в задания:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
server_www# crontab crontab.txt
server_www# crontab -l
</pre>
</div>

Должна отобразиться строка, введенная ранее в crontab.txt.<br>
<br>

Первый раз запустите <em>new_month.pl</em> вручную:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
server_www# cd /usr/local/nodeny
server_www# perl new_month.pl
</pre>
</div>


После отработки скрипта, изучите логи в файле NEW_MONTH_LOG_X.XXXX и NEW_MONTH_ERROR_X.XXX. Последний
хранит лог ошибок и в обычном случае он не должен существовать, т.е не должно быть ни одной ошибки. Поскольку
операция перехода на новый месяц ответственная, вы должны убедиться, что все клиенты были переведены.
Если в процессе перевода возникнет ошибка, например, станет недоступна БД либо иной сбой, то скрипт
new_month.pl попытается восстановить соединение. Если же это не удастся, то скрипт запишет в
NEW_MONTH_ERROR_X.XXX сообщение где произошла ошибка. Когда при изучении данного лога, вы обнаружите, что не
все клиенты были переведены - запустите скрипт снова - он не будет повторно переводить клиентов, которые
уже прошли эту процедуру.<br>
<br>

Кроме того, по окончании работы, new_month.pl записывает соответствующеее итоговое событие в БД, которое
вы можете увидеть в админке.<br>
<br>

Как было сказано выше, для каждого клиента формируется платеж-снятие согласно пакета тарификации
и потребленного им трафика. Хотя скрипт запускается в начале месяца, записи о снятиях проводятся предудущим
месяцем - за 5 секунд до его окончания. Это необходимо для корректной отчетности.<br>
<br>


Перед &#171;переходом на новый месяц&#187; будет не лишним сделать 
<a href='work.html#backup'>резервную копию базы данных</a>.<br>
<br>

Рекомендуется запускать new_month.pl как можно ближе к 00:01 первого числа месяца. При наступлении 1го числа,
трафик продолжает считаться и если осуществить поздно переход, то трафик с начала месяца
до момента запуска скрипта будет считаться трафиком за прошлый месяц. Таким образом, будет некоторое
несоответствие в данных клиента. Например, абонент скачал 50Мб в январе, наступило 1 февраля,
клиент продолжает загружать из интернета информацию. В 4 часа ночи запускается скрипт перехода на новый месяц
и считает что клиент загрузил в январе 55Мб (5мб успел загрузить за 4 часа в феврале).
Таким образом, с клиента снимутся деньги за 55Мб, после чего трафик обнулится. В статистике клиент будет видеть
что 1-го февраля он загрузил 5мб, но на титульной странице будет отображаться 0Мб - т.к. 5Мб
уже засчитаны в предыдущий месяц. То есть чем позже будет запущен скрипт new_month.pl, тем больше будет разница
в суточных и общих данных.<br>
<br>


Запускайте new_month.pl в 00:01 первого числа каждого месяца и такой проблемы у
вас не будет.<br>
<br>

Если же по каким-либо причинам вам необходимо запустить скрипт не первого числа, то при запуске используйте ключ t:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
server_www# perl new_month.pl -t
</pre>
</div>

<br>
Условия при которых с наступлением нового месяца не производится списание денежных средств со
счета клиента:<br>
<br>
1) Если клиент находится в группе, в характеристиках которой указано не
производить списание средств (например группа &#171;удаленные&#187;)<br>
<br>
2) Если параметр клиента &#171;день начала потребения услуг&#187; отрицательный -
 означает, что клиент ни одним из его ip не авторизовался и не потреблял интернет никогда с момента создания
его данных<br>
<br>
<br>


<a name="del"><div class="coment" align=center><b>Удаление клиента</b></div></a><br>
Возможны 2 варианта удаления:<br>
- удаление всех данных о клиенте из всех таблиц;<br>
- перевод клиента в группу &#171;удаленные&#187;.<br>
<br>
В случае, когда клиент разорвал контракт/отключился от сети, более правильным решением
является не удаления его данных, а установка признака &#171;отключенный клиент&#187;, при этом
в списке пользователей такой клиент не будет фигурировать, однако все данные
его касающиеся будут сохранены. Таким образом, впоследствии, если клиент захочет переподключиться,
будет известен его долг, личные данные, переписка и т.д. Для переключения в такой режим
достаточно на странице редактирования данных клиента выбрать группу &#171;Удаленные&#187;.
Также для таких клиентов необходимо создать специальный пакет (назвать, к примеру, &#171;отключенные&#187;)
с ценой = 0, переработкой = 0 и трафиком всех направлений = 0. Обратите внимание, что группа &#171;Удаленные&#187;
задается в настройках, в параметрах этой группы необходимо выставить флаги &#171;не показывать в основном списке&#187;
и &#171;не снимать деньги при переходе на новый месяц&#187;.<br>
<br>
<br>



<a name="alias"><div class="coment" align=center><b>Клиенты, имеющие несколько ip-адресов</b></div></a><br>
NoDeny имеет возможность назначить клиенту несколько ip-адресов с которыми он будет иметь
доступ в интернет. При этом денежный счет будет общим и будет рассчитываться на основе суммарного
трафика со всех ip адресов клиента. Для этого необходимо внести клиента в NoDeny под
каким-либо одним ip. Эта запись будет именоваться основной, т.е. все денежные
расчеты будут происходить с ней. Эта же учетная запись будет хранить суммарный трафик по остальным
ip-клиента, которые будут называться алиасными. При просмотре статистики, клиент может видеть историю
трафика/залогинивания и т.д. по каждому ip, однако суммарное значение и денежную сумму видит только
при просмотре данных основной записи.<br><br>
<img src='../i/p13.gif'><br><br>
На скриншоте видно, что у клиента Подгайный 6 ip-адресов, один из которых назначен компьютеру,
физически находящемуся по другому адресу (Червоного Козачества 72/11). 10.20.17.11 - основная запись,
10.2.0.70 и 10.2.2.32 - не требуют авторизации L2, 10.2.2.32 в данный момент авторизован,
122.15.230.10 - доступ заблокирован <br>
<br><br>
Алиасные записи имеют свой логин и пароль, свое состояние (на подключении/ремонт/вирусы),
свою точку подключения и адрес (т.е. возможно сделать у разных клиентов общий счет)
и другие параметры. Баланс, лимит отключения, список услуг, день начала потребления услуг
хранит только основная запись<br>
<br><br>

<a name="block"><div class="coment" align=center><b>Блокировка доступа</b></div></a><br>
<br>
Варианты блокировок доступа в интернет клиенту:<br><br>
- вручную администратором;<br>
- автоматическое отключение при финансовой задолженности;<br>
- автоматическое отключение при превышении пакетных мегабайт;<br>
- временное отключение в заданный промежуток времени в сутках;<br>
- отключение при вирусной активности.<br>
<br>
Обратите внимание, что существует 2 вида отключения: временное и постоянное.
При постоянном отключении параметр &#171;доступ&#187; в записи клиента переводится в режим &#171;запрещен&#187;  и в списке
клиентов такие записи помечаются красным фоном. Включить такие записи можно двумя способами:
либо вручную администратором либо автоматически при пополнении счета (если в настройках биллинга включена эта возможность).<br><br>
Ручное включение администратором (также отключение) производится на странице редактирования
данных клиента, см. поле &#171;Доступ&#187;.<br><br>
<b>Отключение при финансовой задолженности</b> приводит к постоянной блокировке доступа 
(в отличие от превышения пакетных мегабайт). Обратите внимание на условия при которых произойдет
отключение:<br><br>
- в настройках записи клиента должна стоять галочка напротив поля &#171;лимит&#187;, а в самом поле должно быть
прописано денежное значение, если баланс клиента станет ниже этого значения, то произойдет отключение;<br>
- в настройках биллинга важный параметр &#171;день последнего платежа&#187; определяет когда и как производить
 сравнение баланса с выставленным лимитом кредита.<br><br>
Проблема состоит в том, что разные провайдеры по разному считают баланс клиента, т.е. одни работают по предоплате,
другие по постоплате, некоторые разрешают работать в кредит несколько дней и т.д.<br><br>
Для настройки под ваши конкретные условия необходимо разобраться в таких моментах:<br><br> 
<ul>
<li><b>начальный баланс</b> - сумма всех проплат клиента минус снятия за услуги (интернет) за прошлые месяцы. 
<em>Не включает стоимость услуг в данный месяц</em></li>
<li><b>стоимость пакета тарификации</b></li>
<li><b>стоимость переработки пакета тарификации</b></li>
</ul><br><br>
Таким образом если провайдер работает по предоплате, то он считает баланс клиента равным:<br><br>
<b>начальный баланс</b> минус <b>стоимость пакета</b> минус <b>стоимость переработки пакета</b><br>
<br>
Если в таком случае провайдер разрешает своим клиентам работать в кредит определенное количество дней, то
необходимо установить параметр &#171;день последнего платежа&#187;. Если текущий день меньше этого параметра, то
лимит (кредит) клиента будет сравниваться с начальным значением баланса, т.е. не будет учитываться
стоимость пакета и его переработка. В остальные дни лимит будет сравниваться с конечным значением баланса.
Параметр &#171;Режим проверки баланса&#187; управляет будет ли учитываться  стоимость переработки в дни до
&#171;дня последнего платежа&#187; (1 - учитывать, 0 - нет).<br><br>
Пример:<br><br>
У клиента на счету 250 руб.<br>
Стоимость пакета 200 руб.<br>
Лимит отключения 0 руб.<br>
Провайдер разрешает работать в кредит 7 дней, т.е. дата последнего платежа = 8<br>
Сегодня 5-е число, клиент выработал пакетные мегабайты и переработал на 100 руб, т.е. сумма снятий за этот месяц 200+100 = 300 руб<br>
<br>
Т.к. провайдер разрешает работать в кредит до 8го числа, то отключение клиента не произойдет т.к. 
начальный баланс 250 руб не ниже границы отключения в 0 руб.<br>
8 числа при проверке на отключение будет сравниваться конечное значение баланса, т.е 250 - 300 = -50 руб и т.о.
если клиент не пополнит счет, то ему будет заблокирован доступ в интернет.<br><br>
В данном примере мы не учли параметр &#171;Режим проверки баланса&#187;. Если он будет равен 1, то
при сравнении начального баланса будет учитываться стоимость переработки. Так как 250 руб - 100 руб
(переработка) &gt; 0, то отключения не произойдет. Как только переработка превысит начальный баланс, то
произойдет отключение несмотря на то что не наступила дата окончания кредитования.<br><br>
Если провайдер не предусматривает работу в кредит, то необходимо установить параметр &#171;день последнего платежа&#187;
равным нулю<br><br>
Если &#171;день последнего платежа&#187; установить в значение 32 - это будет означать работу по постоплате, т.е.
в любой день месяца  при проверке на отключение не будет учитываться стоимость пакета и отключение произойдет
только в начале следующего месяца.<br><br>
<b>Отключение при превышении размера пакетных мегабайт</b> временное, т.е. запись не помечается красным цветом и
доступ блокируется до начала следующего месяца. Блокируются только те клиенты, в пакетах которых
цена превышения равна 0, что будет означать запрещение переработки пакета. Обратите внимание, что
с началом нового месяца, когда обнулится трафик, клиенту будет разрешен доступ.<br><br>
<b>Временное отключение в заданный промежуток времени в сутках</b> определяется параметрами соответствующего
пакета. Для этого необходима в настройках биллинга указать вывод расширенных настроек пакетов.<br>
<br>
<br>
<br>


<a name="minus"><div class="coment" align=center><b>Проблема &#171;ухода в минус&#187;</b></div></a><br>
<br>
Существует классическая проблема всех биллингов, связанная с тем, что невозможно отключить доступ клиенту точь в точь
в момент достижения баланса границы отключения. Связано это с дискретностью периодов снятия статистики. Т.е. клиент
может исчерпать свои средства до осуществления среза статистики, например посредине этого периода. При подсчете трафика
оказывается, что за счет переработки баланс клиента становится ниже границы отключения, причем иногда на большую величину -
скорости в интернет сейчас огромные, трафик за несколько минут может быть поглощен значительный.<br>
<br>
Вы должны понимать, почему клиент потребил трафик уже после того, как превысил границу отключения. Дело в том, что
на получение статистики от коллекторов трафика отводится определенное время, далее на подсчет тратится несколько секунд,
после чего несколько секунд тратится на запись данных в базу данных и блокирование доступа в интернет. Агент доступа
реагирует не мгновенно, а тоже через несколько секунд, обычно от 0 до 10. В итоге получается, что клиенту доступ
физически блокируется немного позже того как он &#171;ушел в минус&#187;. Поэтому в статистике будет наблюдаться
некоторое количество трафика в следующий период после блокирования доступа.<br>
<br>
Безлимитные тарифы, естественно, не имеют такой особенности.<br>
<br>
<br>
<br>


<a name="card"><div class="coment" align=center><b>Карточки пополнения счета</b></div></a><br>
<br>
Карточки пополнения счета позволяют пополнить счет самим клиентом введя код пополнения в клиентской статистике аналогично
пополнению счета скретч-картами у мобильных операторов.<br>
<br>
Нюансы:<br>
<br>
<ul>
<li>счет клиента пополняется безналично.</li>
<li>админстратор имеет возможность лично активировать из админки карточку на любого клиента, при этом в комментарии к
соответствующему платежу указывается, что активировал администратор.</li>
<li>в платеже сохраняется идентификационный номер карты пополнения. По этому коду в таблице карточек администратор
с достаточными привилегиями может установить код пополнения, а также кем была реализована карточка.</li>
<li>настраиваемо количество попыток активации кода пополнения за определенный интервал времени.</li>
<li>параметры кода пополнения могут состоять либо только из кода пополнения либо логина+пароля, это настраиваемо
как и количество символов, срок действия.</li>
</ul>
<br>
Первоначально карточки пополнения генерируются администратором с соответствующими правами, после чего сгенерированные
карточки начинают числится за ним. Понятие &#171;склад&#187;, существующее в предыдущих версиях
NoDeny, полностью отсутствует. Любая карточка всегда за кем-то закреплена. В процессе, администратор может оформить передачу
определенного диапазона карточек на других администраторов. При этом окончательная передача осуществится только после
подтверждения принимающим админом.<br>
<br>
Поскольку карточки пополнения счета это фактически денежный эквивалент, то при выводе статистики по админу, карточки числятся
на нем в виде этого денежного эквивалента.<br>
<br>
Любая карточка всегда находится в одном из состояний:<br>
<ul>
<li>не активирована и может быть активирована</li>
<li>не активирована и пока не может быть активирована</li>
<li>заблокирована - не может быть активирована никогда</li>
<li>активирована</li>
<li>в состоянии перемещения, не может быть активирована пока не выйдет из этого состояния</li>
</ul>
Отличие первого состояния от второго обусловлено тем, что в NoDeny существует 3 способа реализации карточек
пополнения счета:<br>
<br>
<ul>
<li>реализаторами, распространяющими карточки вне NoDeny;</li>
<li>администраторами через NoDeny;</li>
<li>администраторами через NoDeny в виде ваучеров.</li>
</ul>
<br>
При распространении карточек через NoDeny (2й вариант) происходит следующее: администратор получает от клиента деньги, взамен выдает
карточку пополнения счета, при этом вводя в админку серийный номер этой карточки. NoDeny из БД узнает номинал
этой карточки и проводит соответствующий платеж-продажу карточки. Следовательно, каждая проданная карточка регистрируется
в платежах, поэтому имеется возможность точно контролировать наличность на руках администратора, занимающегося продажей.<br>
<br>
Необходимость проводить через биллинг продажу каждой карточки может показаться избыточной. Однако, опыт автора говорит о том, что
админситраторы занимающиеся реализацией карточек, желают работать именно таким методом, поскольку в любой момент имеется возможность
получить информацию о том сколько карточек и каких номиналов в данный момент на руках у администратора.<br>
<br>
Более того, описанный способ обладает повышенной безопасностью. Дело в том, что после реализации карточек, NoDeny
помечает карточку как &#171;не активирована, можно активировать&#187;, а до продажи карточка находится в состоянии
&#171;не активирована, пока нельзя активировать&#187;. Поэтому в случае утери карточек, передачи клиенту без получения денег и др.
случаев - клиент не сможет активировать карточку не решив спорный вопрос с администрацией.<br>
<br>
При распространении карточек через торговую сеть, когда они продаются не регистрируясь в биллинге, схема слегка меняется.
Карточки, переданные на таких реализаторов, должны сразу помечаться как &#171;не активированные, можно активировать&#187;, поскольку
при попытке активации нет никаких вариантов знать продал ли реализатор карту или нет.<br>
<br>
Для того, чтобы не вникать в эти нюансы в процессе работы, необходимо в настройках учетных записей администраторов указать
кто из них является реализатором, а кто администратором, продающим карточки через биллинг. Из этого предложения становится
очевидным, что все реализаторы должны быть занесены в NoDeny. Для этого создайте специальный отдел &#171;Реализаторы&#187; и внесите
туда по очереди всех реализаторов. Права, естественно, никакие не давать, поскольку эти записи создаются только для контроля
на каком реализаторе числятся какие карточки и сколько денег нам он передал.<br>
<br>
Выше упоминалось, что передача карточек требует подтверждения принимающим админом. Поскольку реализаторы обычно не имеют доступ к админке
NoDeny, следовательно никак не могут подтвердить прием карточек. Поэтому в настройках учетной записи каждого реализатора необходимо
установить флаг, что перевод карточек на данного реализатора не требует подтверждения.<br>
<br>
Текже, не забудьте установить флаг `Автоматический перевод принятых карточек в режим &#171;можно активировать&#187;`.<br>
<br>
Передачи наличных от реализаторов должны оформляться именно как передачи, а не как приход в кассу. Передача -
это всегда изменение состояние кассы у обоих сторон: у принимающей и у передающей. Операции с понятием &#171;касса сети&#187;
должены осуществляться только в том случае если одной из сторон финансовой операции является субъект, который отсутствует
в базе данных NoDeny, например, оплата за интернет канал, оборудование и т.д. (если провайдер и поставщики не занесены в БД)<br>
<br>
Ваучерная реализация предусматривает, что код пополнения выдается клиенту в открытом виде в виде ваучера в момент получения наличных
администратором. Администратор делает запрос в NoDeny на получение кода пополнения соответствующего номинала.
При этом формируется платеж &#171;в кассу&#187; (обратите внимание, что платеж оформляется как приход в сеть и не связан ни с каким клиентом,
поскольку купить может один абонент, а активировать другой) в авторстве данного администратора. В таблице карточек устанавливается
признак, что карточка продана данным администратором и какой платеж соответствует данной продаже. В случае недоразумений, администратор
имеет возможность заблокировать <em>неактивированый реализованный им</em> ваучер, при этом удаляется соответствующий
платеж и карточку невозможно будет активировать. Т.к.клиент, по условиям, указанным на бланке ваучера, обязан
сохранить его, имеет возможность при неактивации предъявить этот ваучер, после чего ему выдается новый либо
отдаются наличные. Для возможности таких операций, ваучер должен подкрепляться, например, печатью.<br>
<br>
Реализация карточек через NoDeny похожа на реализацию ваучеров тем, что в первом случае так же проводится платеж в кассу поскольку
продажа ваучера не связана ни с каким клиентом. При этом карточка перестает числится за администратором, вернее остается лишь пометка,
что он ее продал. Обратите внимание, на интересную особенность связанную с таким подходом. Упоминалось, что карточки это
фактически денежный эквивалент, поэтому администратор, имеющий на руках 100 карточек номиналом 10 грн, фактически имеет на руках
1000 грн. При реализации одной карточки, проводится платеж &#171;в кассу 10 грн&#187;, следовательно NoDeny  считает, что у администратора на 10 грн больше.
Однако, после продажи, на администраторе числится уже не 100 карточек, а 99, что эквивалентно 990 грн. Исходя из этой
схемы понятно, что наличность на руках админа это сумма реальной наличности и денежного эквивалента в виде карточек.<br>
<br>
Управление карточками пополнения счета осуществляется в меню <b>[Операции]-&gt;[Карточки пополнения счета]</b><br>
<br>
<br><br><br>



<a name="mail"><div class="coment" align=center><b>Почта</b></div></a><br><br>
Если у вас есть почтовый сервер (локальный или удаленный) на базе Postfix с клиентской базой в mysql,
то у вас есть возможность управлять почтовыми ящиками клиентов в самом биллинге.<br><br>
Настройка заключается в:<br>
<br>
1) Клиентская таблица в почтовой базе должна иметь такие поля:<br><br>
- текстовое поле для хранения названий почтовых ящиков<br>
- текстовое поле для хранения паролей почтовых ящиков<br>
- текстовое поле для хранения имени клиента<br>
- текстовое поле для хранения пути к почтовому ящику клиента<br>
- целочисленное поле для хранения флага блокировки почтового ящика<br>
<br>
Пример таблицы:<br>
<br><pre>CREATE TABLE `users` (
  `email` varchar(128) NOT NULL default '',
  `passwd` varchar(128) NOT NULL default '',
  `maildir` varchar(255) NOT NULL default '',
  `enabled` tinyint(4) NOT NULL default '1',
  `name` varchar(60) default NULL,
  PRIMARY KEY  (`email`)
) TYPE=MyISAM;
</pre>
Названия полей непринципиальны, т.е могут быть любыми, их можно задать в настройках nodeny. Поле для
имени клиента в реальности будет содержать ip-адрес клиента, а не его имя. На один ip  система может
назначить неограниченное количество email-ов. Принято считать если поле <em>enabled</em> = 0, то ящик считается
заблокированным, 1 - рабочим. Рекомендуем расширить значение этого поля таким образом:<br>
<br>
2 - разрешено только принимать почту, клиент не сможет забирать почту с сервера<br>
1 - разрешено принимать почту и клиент сможет забирать почту с сервера<br>
0 - почтовый ящик заблокирован<br>
<br>
Вышеперечисленное может понадобится в таком случае: если в ваших тарифах предусмотрен бесплатный почтовый ящик
на определенных пакетах и клиент, получив email, в следующем месяце переходит на пакет не предусматривающий бесплатный
почтовый ящик - в этом случае можно запретить забор почты клиентом, однако оставить функционирующим почтовый ящик<br>
<br>
В настройках postfix для mysql есть параметр <em>additional_conditions</em> с помощью которого
можно указать условие работоспособности ящика:<br>
<br><pre>
mail-server# cat mysql-virtual-maps.cf 

user = postfix
password = hardpassword
dbname = mail
table = users
select_field = maildir
where_field = email
additional_conditions = and enabled > 0
hosts = localhost
</pre>
<br>
2) На почтовом сервере необходимо создать юзера с правами select,update,insert,delete почтовой базы. Разрешить
коннект с сервера nodeny, например:<br>
<br>
<pre>GRANT USAGE ON *.* TO "nodeny_mail"@"10.0.0.1" IDENTIFIED BY "nodypassword";
GRANT SELECT, INSERT, UPDATE, DELETE ON `mail`.`users` TO 'nodeny_mail'@'10.0.0.1';
</pre><br>
В данном примере предполагается, что <em>nodeny</em> находится на сервере <em>10.0.0.1</em>,
почтовый сервер на другом сервере. Создается учетная запись <em>nodeny_mail</em>, которой
разрешено логиниться с сервера <em>10.0.0.1</em> и производить основные операции с базой <em>mail</em>.
Находясь на сервере 10.0.0.1, проверить работоспособность можно:<br>
<pre>
shell&gt; mysql -p -u nodeny_mail -h 10.0.0.2
mysql&gt; connect mail;
mysql&gt; select * from users;
</pre>
<br>
<br>
3) Осуществить настройку в разделе <em>Почта</em> в админке nodeny и дать администраторам права на работу с почтовыми ящиками
<br><br><br>
<a name="job"><div class="coment" align=center><b>Задания работникам</b></div></a><br>
Система NoDeny позволяет вести учет выполнения заданий работниками сети. При аккуратном подходе к выдаче заданий,
в любой момент можно выяснить кто из работников когда вел работы по подключению/ремонту/настройке клиента,
кто ответственный, результат выполнения работы, время выполнения работы, администратор выдавший задание.
Таким образом возможно выяснить кто же виновен в определенной ситуации, которая проявилась не сразу. Ведется
статистика сколько и какие виды заданий выполнял работник, среднее время выполнения задания, количество замечаний,
статистика по результатам выполнения. Это один из критериев при выдаче зарплаты.<br>
<br>
Для выдачи заданий вам необходимо в первую очередь дать права администратору как на просмотр данных работников, так
и права на выдачу заданий. Права на редактирование данных работников не требуются - это нужно администратору верхнего уровня.<br>
<br>
Задания бывают двух типов:<br>
<br>
- задание, касающиеся конкретного клиента<br>
- другие задания, которые условно называются &#171;по сети&#187;<br>
<br>
Принципиально эти 2 вида задания ничем не отличаются кроме способа их выдачи. В первом случае вам
необходимо открыть данные клиента с которым связано задание и нажать кнопку &#171;задание работникам&#187;.
В появившемся окне необходимо выбрать тип задания (типы заданий задаются в настройках, обычно достаточно:
подключение, ремонт, настройка, первоначальная настройка, иной вид работ). NoDeny пытается минимизировать действия администратора
путем подстановки наиболее подходящего вида работ, например если клиент в состоянии &#171;заявка на ремонт&#187;, то будет подставлен
вид работ &#171;ремонт&#187;, если состояние &#171;на подключении&#187; - &#171;подключение&#187;. Ниже можно указать комментарий если необходимо.
Еще ниже будет выведен список работников напротив которых будет 2 поля checkbox (галочки). Напротив каждого,
отсылаемого на задание, работника вы должны поставить одну галочку (можно две, первая приоритетней). Если работник
ответственный за задание, т.е главный в бригаде либо один на задании, ставьте галочку в первом столбце, иначе во втором.
Нажимайте кнопку &#171;выдать задание&#187;. С этого времени будет считаться, что задание выдано, будет включен счетчик времени,
работники будут помечены &#171;на задании&#187;.<br>
<br>
Список текущих заданий можно посмотреть в разделе <b>[клиенты]-&gt;[задания работников]</b>. К каждому
заданию будут прилагаться данные: когда было выдано, сколько времени выполняется, кто выполняет, кто ответственный,
кто выдал задание. Ниже будет выведена кнопка &#171;закончить задание&#187;, при нажатии на которую, будет выведено
окно в котором предложат ввести результат выполнения задания (успешно/частично/неудовлетворительно (не) по вине работником/отменено),
а также предложено поставить галочку-замечание работником чья работа неудовлетворительна. Ставьте галочку только
в этом случае. Если же вы хотите оставить положительное замечание работнику, это необходимо сделать выбрав список
работников, нажать &#171;замечание&#187;, выбрать рейтинг (от -5 до +5) и поставить комментарий<br>
<br>
Одному работнику (бригаде) можно назначить несколько заданий одновременно. Это может быть необходимо, когда он (они)
получат пакет заданий и будут отчитываться о выполнении каждого в процессе. В таком случае, для того чтобы
в статистике не суммировалось время каждого задания (например, выполнено 3 задания за 3 часа, все 3 задания были
поставлены сразу и будет считаться что затрачено было 9 часов), после завершения одного задания, автоматически
для всех оставшихся заданий будет выставлено текущее время постановки задания

<br><br><br>
<div class="coment" align=center><b><a name="stat">Клиентская статистика</a></b></div></a><br>
<br>
<b>Заказ пакета</b> - позволяет клиенту самостоятельно заказать автоматическое переключение пакета
с началом нового месяца. Эту возможность можно запретить в настройках. Естественно клиенту
необходимо заблокировать возможность заказа &#171;неофициальных&#187; пакетов (административных, льготных и др).
У каждого пакета есть флаг, позволяющий запретить вывод данного тарифа в списке тарифов &#171;на заказ&#187;.
Также есть флаг запрещающий клиенту самостаятельно менять тариф на какой-нибудь другой.<br>
<br>Если клиенту запрещен доступ в интернет он не может заказать тариф на новый месяц.<br>
<br>
Понятие <b>&#171;Как видит клиент&#187;</b>. Как ни странно при определенных условиях данные которые предоставляются
клиенту могут отличаться от данных, предоставляемых администратору. Причем последнее определяется как раз
требованиями администратора. В основном это касается типов трафика. Если вам необходимо, чтобы
клиент не замечал (буквально даже не подозревал о существовании) некоторых видов трафика, к примеру
&#171;игровой трафик&#187;, &#171;городской&#187;, но которые необходимы для других клиентов, вы можете указать это в тарификации.
При этом деление трафика на направления будет происходить <em>всегда</em>, однако для выбранных
клиентов выбранные направления будут перераспределяться на основное направление. В конечном итоге
клиент на странице своей статистики будет видеть общий трафик и посуточно и детально. Так же
при проверке ip адреса на попадание в сеть определенного направления будут вносится коррективы.
Когда страницу статистики будет просматривать администратор, ему будут выводится предупреждения
о перераспределения трафика<br>
<br><br>
<br><br>
<br>


<div class="coment" align=center><b><a name="ermess">Сообщения об ошибках</a></b></div></a><br>
<br>
<a name="eraccess">Ошибки доступа к админке:</a><br>
<br>



<table border=1><tr align=center><td><br>Сообщение<br><br></td><td>Описание проблемы и ее решение</td></tr>
<tr><td valign=top align=left>Ошибка 100</td>
<td>Кофигурационный файл отсутствует либо в админке неправильно указано его местонахождение.
Отредактируйте скрипт adm.pl (он находится в папке /....../cgi-bin/adm/) в одной из начальных строк:<br>
<br>
<pre>
$Main_config='/....../nodeny.cfg.pl';
</pre>
и укажите правильные данные.</td></tr>


<tr><td valign=top align=left>Ошибка 101</td>
<td>Конфигурационный файл (обычно nodeny.cfg.pl) существует,
однако он недоступен для чтения пользователю от имени которого запущен веб-сервер.
Конфиг должен иметь владельца www и права 600 - т.е. чтобы была возможность только его загрузки и модификации
юзером www. Также файл должен находиться в папке (/usr/local/nodeny), у которой должен быть владелец www и права 700.</td></tr>


<tr><td valign=top align=left>Ошибка 102</td>
<td>Не найден файл calls.pl - должен находиться в /usr/local/nodeny/web/. Проверьте чтобы владелец calls.pl и
/usr/local/nodeny/web/ был www.</td></tr>

<tr><td valign=top align=left>Ошибка 103</td>
<td>Не удалось загрузить файл calls.pl - проверьте права доступа на этот файл.</td></tr>

<tr><td valign=top align=left>Ошибка 104</td>
<td>Разные версии скриптов NoDeny. Вероятно, обновление было некорректным либо незавершеным.</td></tr>

<tr><td valign=top align=left>Ошибка 110</td>
<td>Админка не может соединиться с основной базой данных. Возможные причины:<br>
<br>
- база данных недоступна - нет связи с удаленным сервером, стоит запрет на соединение в фаерволе на сервере баз данных либо
на сервере с админкой;<br>
<br>
- перегруженность базы данных либо несдостаточность ширины канала для установления соединения в отведенный лимит времени -
ситуация маловероятная, но теоретически возможная;<br>
<br>
- неправильные параметры соединения с базой данных.<br>
<br>
Начните проверку с логов вебсервера - ошибки модуля DBI (модуль работы с базами данных) попадут туда. Например:<br>
<br>
<em>bash# tail /var/log/httpd-error.log</em><br>
<br>
[Sun Nov 11 13:21:18 2007] [error] [client xx.xx.xx.xx] DBI connect('database=bill;host=yy.yy.yy.yy;mysql_connect_timeout=4','bill_www',...) failed: Host 'yy.yy.yy.yy' is not allowed to connect to this MySQL server at /usr/local/www/apache22/cgi-bin/adm/adm.pl line 194<br>
<br>
видно, что проблема не в mysql, а в параметрах соединения (неправильный логин, пароль, либо же в таблице привилегий mysql не
указан текущий сервер).<br>
<br>
Если вы хотите изменить настройки системы nodeny, например изменить логин или пароль соединения с БД - вам необходимо залогиниться
под системным логином.</td></tr>
</table>
<br>
<br>
<br>
<br>







<div class="coment" align=center><b><a name="backup">Бекап</a></b></div><br>

Крайне рекомендуется наладить периодический процесс бекапов данных NoDeny - никто не застрахован
от ошибок как человеческого фактора, так и аппаратных. Поскольку файлы NoDeny - это статическая
информация, то их бекап можно сделать однократно сразу после окончания настройки. Динамические данные,
т.е информация в базе данных, рекомендует регулярного их бекапа, скажем, раз в сутки и желательно на удаленный
сервер.<br>
<br>

На сервере основной БД создадим скрипт для бекапа:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
cd /etc/periodic/weekly/
ee backup_nodeny.sh
</div>
<br>


<div class='code'><div class='mark'>Редактирование файла backup_nodeny.sh</div><pre>
#!/bin/sh
PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin
passwd_root_mysql='hardpass'
mysql_cmd='/usr/local/bin/mysql'
mysqldump_cmd='/usr/local/bin/mysqldump'

fl=`date "+%d-%m-%Y"`
cd /var/backups/
echo show tables | ${mysql_cmd} -u root --password=${passwd_root_mysql} bill | \
  grep -v '^[stuvxyz]2' | grep -v 'traf_info' | grep -v '^Tables' | \
  xargs ${mysqldump_cmd} -R -Q --add-locks -u root --password=${passwd_root_mysql} \
  --default-character-set=cp1251 bill $1 > bill_${fl}.sql
tar -c -z -f ${fl}.tar.gz bill_${fl}.sql
rm -f bill_${fl}.sql
chmod 400 ${fl}.tar.gz
</div>
<br>


Запустите на выполнение:<br>
<br>
<div class='code'><div class='mark'>Команды bash</div><pre>
chmod 700 backup_nodeny.sh
./backup_nodeny.sh
</div>
<br>

и убедитесь, что снимок с базы данных сохранен в файле /var/backups/dd-mm-yyyy.tar.gz.<br>
<br>

<div class='code'><div class='mark'>Комментарий</div>
Поскольку детализация трафика занимает существенные объемы, а по сути - это вторичная информация,
то в скрипте указано не бекапить ее.<br>
<br>

Не забудьте в скрипте вместо `hardpass` указать свой пароль для пользователе root mysql.
</div>


Восстановление БД из бекапа:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
server_db#  mysql -p
</pre>
</div>
ввод пароля<br>
<br>

<div class='code'><div class='mark'>Команды mysql</div><pre>
mysql&gt; drop database test;
mysql&gt; create database test;
mysql&gt; use test;
mysql&gt; source bill_dd-mm-yyyy.sql;
</pre>
</div>

<br>
<b>Внимание.</b> Перечисленные действия производят следующее:<br>
<br>
1) <b>Уничтожают</b> базу данных test (если она существует)<br>
2) Восстанавливают базу данных из файла <em>bill_dd-mm-yyyy.sql</em><br>
<br>
Теперь в настройках биллинга смените имя базы данных на test.<br>
<br>


</body>
</html>
