<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - Install</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>

<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Настройка ядра NoDeny</b></td>
</tr></table>
<br><br><br>

Ядро NoDeny - файл <b>nodeny.pl</b> - центр вычислений. Скрипт должен быть постоянно запущенным.<br>
<br>

Ядро NoDeny соединяется с базами данным своим персональным логином <b>bill_kernel</b>. Пример создания
учетной записи bill_kernel:<br>
<br>
<div class=coment><pre>
mysql> CREATE USER 'bill_kernel'@'localhost' IDENTIFIED BY 'hardpass4';
mysql> GRANT USAGE ON *.* TO 'bill_kernel'@'localhost' IDENTIFIED BY 'hardpass4';
mysql> GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,INDEX ON `bill`.* TO 'bill_kernel'@'localhost';
</pre></div>
<br>
Вместо localhost укажите ip-адрес сервера, на котором вы будете запускать ядро NoDeny в случае если
оно будет находится не на одном сервере с БД.<br>
<br>
Отредактируйте файл <em>nodeny.cfg</em> - измените параметры соединения с базами данных:
пароль и адреса баз данных. Все остальные парамеры конфигурации ядро получит из базы данных после старта.<br>
<br>
Ядро необходимо запускать в "вертушке":<br>
<br>
bash# cd /usr/local/nodeny<br>
bash# ./go_kernel.sh &amp;<br>
<br>
Скрипт go_kernel.sh обеспечивает перезапуск nodeny.pl после того как произойдет завершение работы этого скрипта.
Такой механизм предусматривается для рестарта ядра из админке в разделе &#171;управление&#187; -&gt; &#171;рестарт&#187; -
послылается сигнал ядру NoDeny о необходимости завершить свою работу. После завершения работы go_kernel.sh
снова запускает nodeny.pl.<br>
<br>
В случае критической ошибки, когда ядро NoDeny не может стартовать нормально (нет соединения с БД,
не загружается конфиг либо модуль денежных расчетов nomoney.pl), nodeny.pl выдерживает паузу в 600 секунд
и завершает работу, после чего go_kernel.sh снова запускает его (ядро). Пауза в 600 секунд не дает ядру
постоянно перезапускаться, что грозило бы переполнением логов сообщениями об ошибке. Кроме того, в случае
критической ситуации, nodeny.pl пытается отослать сообщение на email администратора. Если конфиг не получен
из БД, то email берется по конфигу, записанному на диск в результате предыдущих стартов.<br>
<br>
В начале скрипт go_kernel.sh запускает nodeny.pl с опцией <em>-nowait</em>, что указывает не выдерживать паузу
в 600 секунд. Это предназначено для ситуаций, когда при старте системы, nodeny.pl запускается до формирования
правил фаервола, что грозит неустановкой соединения с удаленной БД. В таком случае нет смысла ждать 600 секунд
до следующего старта, необходимо подождать несколько секунд, когда сформируются правила в фаерволе и повторить
соединение.<br>
<br>
Также при запуске используется утилита <em>nice</em>, которая повышает приоритет ядра NoDeny как выполняемого процесса
(устанавливается в -15)<br>
<br>
</body>
</html>
