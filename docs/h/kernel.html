<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - Install</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>
<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Ядро NoDeny</b></td>
</tr></table>
<br><br><br>

Ядро NoDeny - файл <b>nodeny.pl</b>. Основные процессы ядра NoDeny выполняются
последовательно для того, чтобы исключить накладки и конфликтные ситуации. Безусловно, в реальности
все процессы происходят параллельно, однако их обработка приводится к последовательной за счет постановки
задания в очередь или аналогичными способами. Тем не менее, хотя последовательная обработка
исключает возникновение сложнопрогнозируемых пересечений, сама имеет значительный недостаток:
необходимо четко контролировать время выполнения каждой операции для того чтобы не было
&#171;затыков&#187;, т.е чтобы обработка одной операции не затянулась, в следствие чего
ожидающие процессы находились бы в забвении все это время.<br>
<br>


Положительным моментом является то, что NoDeny разрабатывался значительное время, при этом
сеть автора постоянно претерпевала изменения как в топологии так и в требованиях. Это все
отразилось в появлении множества нестандартных ситуаций, слабые места которых автор методично
исправлял. В итоге имеем довольно надежное оттюнингованное ядро. Тем не менее, администратору
следует присматриваться не исчерпался ли запас прочности системы и не пора ли проапгрейдить какое-либо
звено.<br>
<br>

Одним из средством анализа запаса прочности является слежение за логами и событиями
ядра NoDeny. Для того чтобы понять их сущность, желательно разобраться в схеме работы
ядра. Больше всего требует к себе внимания процедура получения и обработки данных трафика,
полученных от коллекторов.<br>
<br>
<br>



<b><a name="gettraf">Получение и обработка данных трафика.</a></b><br>
<br>
Процедура обработки трафика выполняется через равные промежутки времени, указываемые в настройках,
либо непрерывно: получили статистику &rarr; обсчитали &rarr; записали &rarr; получили статистику и т.д.
Период запроса статистики указывается в разделе &#171;Операции&#187; &rarr; &#171;Настройки&#187; &rarr;
&#171;Ядро&#187;. Чем меньше промежуток времени, тем оперативней будет обновление клиентской статистики,
а, следовательно, и финансовой информации клиента, поскольку она привязана к трафику. Таким образом, чем
чаще будет происходить срез трафика, тем точнее будет работать процедура блокировки учетной записи клиента
- на больших скоростях клиент может значительно &#171;уйти в минус&#187;, скачав информации
больше лимита в момент между периодами снятия статистики.<br>
<br>

Поскольку все в мире дискретно, то абсолютно исключить такую ситуацию невозможно. Уменьшение периода снятия
статистики ведет к увеличению нагрузки на ядро, хотя не линейно зависит от времени. А так как коллекторы
агрегируют трафик, то они уменьшают количество обрабатываемой информации ядром NoDeny. Таким образом,
если выявлен недостаток ресурсов для обработки информации, то кроме увеличения аппаратных мощностей можно
попытаться увеличить период снятия статистики.<br>
<br>

Если процедура снятия и обработки статистики превышает установленный
администратором период, то она не накладывается на последующую, ее
запуск произойдет уже после окончания обработки.<br>
<br>

Во время работы, собирается статистика времени обработки различных участков
описываемой процедуры, эти данные записываются в таблицу traf_info
основной базы данных и доступны в веб-админке на странице &#171;статистика&#187;.<br>
<br>

Каждые x-секунд процедура вызывает подпрограмму обработки авторизаций клиентов,
таким образом, если во время обсчета трафика какой-либо клиент авторизуется,
то он получит доступ в интернет в течение нескольких секунд и не будет ждать
окончания процедуры обработки трафика.<br>
<br>
<br>




<b><a name="ipcad">Получение данных от коллекторов трафика.</a></b><br>
<br>

На получение данных от коллектора тратится некоторое время. В зависимости от количества
абонентов, передаваемые служебные данные могут занимать до нескольких мегабайт за срез.
На передачу этих данных может потратиться значительное время, если коллектор
географически удаленный, а канал к серверу коллектора не очень широкий.<br>
<br>

На начальном этапе ядро пытается соединиться сразу со всеми коллекторами, запустив в фоне копию скрипта
<em>ipcad.pl</em> (либо <em>netflow.pl</em>) для каждого сервера с коллектором. После этого, ядро,
подождав несколько секунд, начинает мониторить папку /usr/local/nodeny/sql на предмет появления в ней файлов
со статистикой. При вызове скриптов опрашивающих коллекторы, им сообщаются имена файлов, в которые
они должны записать полученные от коллектора данные. В отведенные 60 секунд скрипт должен успеть это сделать.<br>
<br>

Исходя из 60 секундного лимита, <em>ipcad.pl</em> распределяет время таким образом:
выделяет время на указание ipcad переместить данные в чекпоинт - 5 секунд, время на получение
данных из чекпоинта - 20 секунд. Итого 25 секунд. Однако, для перестраховки, в случае
когда ipcad не даст ответ при первом обращении (такое бывает хотя и редко), процедура повторяется.
Итого ipcad.pl должен уложиться в 50 секунд в худшем случае.<br>
<br>

Чекпоинт важное звено в получении точных данных - сначала данные перемещаются в него,
а в основной таблице очищаются, NoDeny же считает данные именно в чекпоинте. Если не производить
подобное перемещение данных, то некоторый трафик может &#171;проскочить&#187; неучтенным в промежуток
между получением данных трафика и обнулением таблицы ipcad с трафиком.<br>
<br>

Поскольку перемещение в чекпоинт внутренняя операция ipcad, то таймаут берется небольшим -
5 секунд. Тем не менее, проверяется ответ чтобы быть уверенным, что процесс
прошел успешно, иначе повторно могут быть посчитаны устаревшие данные в чекпоинте.<br>
<br>

Когда ядро обнаружит, что присутствуют все файлы, оно начнет их обработку. По истечении
60 сек, ядро вне зависимости от присутствия всех файлов, перейдет к их обработке,
естественно залогировав ошибку для конкретного коллектора(ов). Данные о трафике
обрабатываются построчно. Сначала анализируется последний стоблец данных,
по нему определяется как настроен коллектор - на отображение только ip либо же на
отображение ip, порта, протокола и интерфейса. Во втором случае проверяется интерфейс
на соответствие настройкам.<br>
<br>

Если коллектор настроен на вывод статистики без интерфейсов и портов, то понять через какой интерфейс прошел
трафик невозможно, а может и не нужно - если настройка серверов не предусматривает таких конфликтных ситуаций.
Трафик в таком режиме считается в любом случае. Обратите внимание, что такой режим уменьшает служебный трафик
за счет уменьшения информации, т.е возможно снизить нагрузку на сервер (канал), однако лишиться детализации
трафика по портам и протоколам.<br>
<br>

На разных серверах коллекторы можут работать в разных режимах.<br>
<br>

Если в обрабатываемой строке коллектора не выявлено клиента сети - это расценивается как неправильная настройка
системы. На самом деле, очевидно, что если есть трафик, который мы никому не можем начислить, то этот неучтенный
трафик есть дыра. Причиной может являться неправильно настроенный фаервол, пропускающий клиентов без авторизации
с любым (или определенным) ip либо же неправильно настроенное агрегирование ipcad, когда группа адресов
агрегируется в сеть. Агрегирование полезная вещь и рассматривается в другом разделе.<br>
<br>


Неучтенный трафик записывается в дополнительную базу данных в таблицу traf_lost и доступен для анализа в веб-адмике
на странице &#171;Статистика&#187;.<br>
<br>

После того как определен клиент и определен тип трафика (входящий/исходящий) определяется
классификация этого трафика, т.е. определяется направление. Анализируется второй ip с которым
происходит обмен трафиком текущим клиентом.<br>
<br>

ip удаленной стороны прогоняется по таблице с описанием направлений на предмет
попадания в заданную сеть (и порт если указано). Таблица сетей индексируется по 3-му
октету, что сокращает время поиска. 3й октет выбран статистически.<br>
<br>

Если ip не найден в таблице, то он считается трафиком первого направления (класса №1),
за исключением бродкаста и мультикаста - они считаются нулевым направлением. Обратите
внимание на то, что мультикаст и бродкаст могут присутствовать в таблице и
переопределяться на другое, отличное от нулевого, направления.<br>
<br>

На самом деле ip прогоняется по двум таблицам: по таблице с нулевым пресетом и по таблице
с клиентским пресетом. Существование двух разных (не обязательно разных) статистик
призвано облегчить администрирование. Трафик нулевого пресета должен описывать
реальные направления вашей сети, а клиентский пресет - то, как мы оцениваем этот трафик
для клиента. Например, имея один канал в интернет мы создаем всего одно направление
&#171;интернет канал&#187; в нулевом пресете, а в клиентском направления &#171;мировой
трафик&#187;, &#171;игровой трафик&#187;, &#171;городской трафик&#187;.<br>
<br>


В процессе обсчета направлений, ядро накапливает детализированную статистику для тех клиентов,
в группе которых стоит указание собирать такую информацию, либо же это указано персонально для
клиента.<br>
<br>
<br>
<br>
<br>
</body>
</html>
