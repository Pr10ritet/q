<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - Install</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>
<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Установка</b></td>
</tr></table>
<br>
<br>
<br>

<div class='code'>
Автор практически уверен в наличии у вас желания все быстро установить, настроить и получить результат.
Поэтому данная инструкция предусматривает быструю настройку работоспособного решения, практически не вникая в тонкости. Предполагается,
что изучив работу NoDeny на этом решении, в будущем вы приведете систему в оптимальный вид, детально изучив документацию.<br>
<br>

Далее рассматривается вариант установки всей системы NoDeny на один сервер. В будущем не составит труда вынести
отдельные компоненты на несколько, возможно, географически распределенных.<br>
<br>

Все действия выполняются от имени root, что считается не совсем безопасным - опытный админ знает при каких действиях
необходимо переключиться на привилегированную запись, а начинающему поначалу будет проще не отвлекаться на тонкости с правами.<br>
<br>

Некоторые действия достаточно подробно описаны, поэтому поставить систему могут как опытные администраторы так и начинающие.<br>
</div>
<br>
<br>

По ходу настройки вам придется указывать несколько паролей, при ознакомительной установке можно не менять указанные
в примерах, но в боевой рекомендуем взять блокнот и заранее проставить пароли, чтобы избежать путаницы в будущем.<br>
<br>

<table border=1><tr><td align=center>Логин</td><td align=center>Пароль в примере</td><td align=center>Комментарий</td></tr>
<tr><td>root в mysql</td><td>hardpass</td><td>&nbsp;</td></tr>
<tr><td>bill_www в mysql</td><td>hardpass2</td><td>Под логином bill_www административный интерфейс соединяется с базами биллинга</td></tr>
<tr><td>bill_kernel в mysql</td><td>hardpass4</td><td>Под логином bill_kernel ядро и агенты на том же сервере соединяются с базами биллинга</td></tr>
<tr><td>admin в админке NoDeny</td><td>hardpass</td><td>
 Этот логин используется только на этапе настройки, после чего автоматически удаляется, т.е пароль можно не менять</td></tr>
<tr><td>nodeny в админке NoDeny</td><td>&nbsp;</td><td>
 Доступ к админке лучше всего организовать двухступенчатым: сначала под общим логином (например, nodeny), потом авторизация под персональным</td></tr>
</table>
<br>
<br>

Общее представление о построении NoDeny:<br>
<ul>
<li><a href='descr.html'>Структурная схема</a></li>
<li><a href="descr.html#prkt">Проектирование системы</a></li>
</ul>
<br>

<a name='start'>Рекомендуемая последовательность установки NoDeny:</a><br>
<br>
<ul>
<li><a href="freebsd.html">Установка системы</a></li>
<li><a href="#db">Установка MySQL-сервера</a></li>
<li><a href="#web">Установка Web-сервера</a></li>
<li><a href="#perl">Установка perl-модулей</a></li>
<li><a href="#upload">Загрузка инсталляции NoDeny на сервер</a></li>
<li><a href="#startweb">Вход в Web-интерфейс NoDeny</a></li>
<li><a href="#safe">Настройка безопасности</a></li>
<li><a href="#admtune">Настройка через Web-интерфейс NoDeny</a></li>
<li><a href="#kernel">Установка ядра NoDeny</a></li>
<li><a href="#agents">Установка агентов авторизации и доступа</a></li>
<li><a href="#collector">Настройка учета трафика</a></li>
<li><a href="#tunedb">Тюнинг mysql</a></li>
<li><a href="tarifs.html">Тарификация</a></li>
</ul>
<br>

В качестве операционной системы возьмем FreeBSD версии 6.x или 7.x и установим, например,
<a href='freebsd.html'>так<a>.<br>
<br>
<br>




<b><a name="db">Устанавливаем MySQL-сервер</a>.</b> Понадобится версия не ниже  5.0:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
cd /usr/ports/databases/mysql50-server/
make BUILD_OPTIMIZED=yes WITH_OPENSSL=yes WITH_CHARSET=cp1251
make install clean
</div>

После установки:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
/usr/local/bin/mysql_install_db
chown -Rv mysql:mysql /var/db/mysql/
</pre>
</div>


Создаем конфигурационный файл из шаблона. Из-за постоянной смены дефолтного местонахождения конфига,
спросим у mysqladmin где mysql будет искать конфиг:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div>
mysqladmin
</div>

<br>

<div class='code'><div class='mark'>Видим на экране</div>
<pre>
Default options are read from the following files in the given order:
/etc/my.cnf /usr/local/etc/my.cnf ~/.my.cnf /usr/local/etc/my.cnf
</pre>
</div>

Поэтому:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
cp /usr/local/share/mysql/my-huge.cnf /etc/my.cnf
</div>

Редактируем конфиг:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
ee /etc/my.cnf
</div>
<br>

 - кодировки в cp1251<br>
 - отменим резолв в днс-имена т.к если днс будет недоступен, то коннекты будут идти ооочень долго,
   в серьезной системе мы должны подстраховаться.<br>
<br>

<div class='code'><div class='mark'>Редактирование my.cnf. Секция [mysqld]</div>
<pre>
default-character-set=cp1251
character-set-server=cp1251
collation-server=cp1251_general_ci
init-connect="SET NAMES cp1251"
skip-character-set-client-handshake
skip-name-resolve
</pre>
</div>

<br>
Стартуем mysql-сервер:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
/usr/local/etc/rc.d/mysql-server forcestart
</div>

<br>
Устанавливаем пароль учетной записи root в mysql:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
/usr/local/bin/mysqladmin -u root password 'hardpass'
</div>

<br>
Автозапуск при старте системы:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
echo mysql_enable=\"YES\" &gt;&gt; /etc/rc.conf
</div>

<br>


<b><a name="web">Устанавливаем Web-сервер для административного интерфейса</a></b>, например,
<em>apache</em> версии 2.2:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
cd /usr/ports/www/apache22/
make install clean
</pre>
</div>

Автозапуск:<br>
<br>
<div class='code'><div class='mark'>Команды bash</div><pre>
echo apache22_enable=\"YES\" &gt;&gt; /etc/rc.conf
echo /sbin/kldload accf_http &gt;&gt; /etc/rc.local
</pre>
</div>

Стартуем без конфигурирования:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
apachectl start
</pre>
</div>

Открываем в браузере:<br>
<br>
<div class='code'><div class='mark'>адресная строка в браузере</div><pre>
http://10.0.0.2/
</pre>
</div>


Если не получаем приветствующего сообщения "It works!" - смотрим логи:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
tail /var/log/httpd-error.log
</pre>
</div>


<br>
<br>
<b><a name="perl">Устанавливаем модули perl</a></b> стандартно из портов:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
cd /usr/ports/databases/p5-DBI && make install clean
cd /usr/ports/databases/p5-DBD-mysql && make install clean
cd /usr/ports/security/p5-Crypt-Rijndael && make install clean
</pre>
</div>
<br>

Для графического формирования карт необходим модуль p5-Imager:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
cd /usr/ports/graphics/p5-Imager && make install clean
</pre>
</div>

Однако на данном этапе его можно не ставить т.к пакет потянет за собой еще несколько
модулей. Перенесем это на потом.<br>
<br>
<br>



<b><a name='upload'>Загружаем</a> на сервер архив с системой NoDeny</b>: <em>nodeny_XX.YY.tar.gz</em>. Хотим предостеречь вас
от попытки разархивировать <em>nodeny_XX.YY.tar.gz</em> и после этого загрузить полученные файлы на сервер - некоторые
программы могут отключить бинарный режим при передаче текстовых файлов, в результате чего содержимое файлов
может быть искажено.<br>
<br>

Загружаем <em>nodeny_XX.YY.tar.gz</em> по ftp, предварительно запустив ftp-сервер:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
ee /etc/inetd.conf
</pre>
</div>

Раскоментируем строку, начинающуюся с &#171;#ftp&#187;. Сохраняем изменения.<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
inetd
</pre>
</div>
<br>


Теперь с компьютера, на который получили архив nodeny, запускаем ftp-клиент. Например, под Windows:<br>
<br>
<div class='code'><div class='mark'>Команда Windows</div><pre>
C:\&gt; ftp 10.0.0.2
</pre>
</div>
<br>
Вводим логин и пароль.<br>

<br>
<div class='code'><div class='mark'>Команды ftp-программы</div><pre>
binary
put nodeny_XX.YY.tar.gz
quit
</pre>
</div>
<br>


Разархивируем и запускаем на выполнения инсталляционный скрипт:<br>
<br>
<div class='code'><div class='mark'>Команды bash</div><pre>
tar -xf nodeny_XX.YY.tar.gz  -C /root
cd /root/nodeny
perl install.pl
</pre>
</div>

<br>
Инсталляционный скрипт работает в режиме диалога: задает несколько вопросов, после чего
проводит инсталляцию. Вопросы будут двух типов: yes/no, а также просьбы ввести какие-либо данные,
например путь. Если ничего не ввести - это будет означать, что вы согласились с данными по
умолчанию, например:<br>
<br>
[ND Installer] nodeny dir [/usr/local/nodeny]:<br>
<br>
Здесь скрипт спрашивает путь к папке, куда будет установлен NoDeny, при этом в квадратных
скобках предлагает вариант по умолчанию, т.е. если ничего не вводить, а нажать enter,
то будет принят вариант `/usr/local/nodeny`. Если данные будут некорректными, то скрипт
может повторить вопрос.<br>
<br>
Итак, после запуска инсталляционного скрипта install.pl, получаем вопрос:<br>
<br>
<pre>
[ND Installer] Select the action:
          1) Install
          2) Upgrade
        any) Exit
Your choice :
</pre>

Поскольку мы инсталлируем, а не обновляем систему - выбираем первый пункт.<br>
<br>
[ND Installer] nodeny dir [/usr/local/nodeny]:<br>
<br>
- нажимаем enter, т.е принимаем вариант по умолчанию. Если такая папка существует,
что возможно, если вы ранее пытались установить систему, тогда скрипт выведет предупреждение:<br>
<br>
[ND Installer] /usr/local/nodeny exists. Probably You need to upgrade It. Are you sure NoDeny need to be installed? [y/n]:<br>
<br>
т.е. будет задан вопрос действительно ли мы инсталлируем NoDeny, а не пытаемся обновить предыдущую версию.
Соглашаемся (`y`). Кстати, на всякий случай скрипт делает бекап этой папки.<br>
<br>
[ND Installer] www dir [/usr/local/www/apache22/data]:<br>
<br>
- здесь спрашивается расположение корневой папки Web-сервера. На данный момент для apache 2.2 путь
`/usr/local/www/apache22/data`, т.е. нажимаем enter ничего не вводя. Если папка не будет найдена,
например, если вы используете иной Web-сервер, тогда необходимо смотреть конфиг этого Web-сервера.<br>
<br>
[ND Installer] cgi-bin dir [/usr/local/www/apache22/cgi-bin]:<br>
<br>
- аналогичный вопрос, касающийся папки cgi-bin.<br>
<br>
[ND Installer] mysql server [localhost]:<br>
[ND Installer] mysql root password [hardpass]:<br>
[ND Installer] NoDeny database [bill]:<br>
<br>
- на все вопросы отвечаем нажатием на enter, т.е вводим данные по умолчанию.<br>
<br>
После этого скрипт создаст базу данных bill, если root-пароль для mysql был введен правильно.
Затем, используя вызов утилиты mysql попытается воспроизвести структуру базы данных NoDeny,
хранящуюся в файле bill.sql.<br>
<br>
Cообщение:<br>
[ND Installer] Database `bill` exists. ALL DATA WILL BE LOST! Continue? [y/n]:<br>
<br>
говорит о том, что база данных bill существует и что при продолжении инсталляции все данные будут утеряны.
Сообщение может возникнуть, если вы по каким-либо причинам запустили повторно инсталляцию, например,
прервали ее предыдущее выполнение, когда БД уже была создана. Т.к. мы действительно
инсталлируем NoDeny, а не обновляем его, смело продолжаем - жмем `y`.<br>
<br>
[ND Installer] nodeny www user in mysql (`no` - do not create) [bill_www]:<br>
<br>
Вопрос о имени mysql-юзера для административного интерфейса. Соглашайтесь с предложенным по умолчанию.<br>
<br>
[ND Installer] Password for nodeny www user in mysql [hardpass2]:<br>
[ND Installer] Ip of nodeny www user in mysql [localhost]:<br>
<br>
Если такой юзер уже существует (повторный запуск инсталляции) - будет задан вопрос `продолжать y/n`?<br>
<br>
[ND Installer] User exists in mysql. Continue? [y/n]:<br>
<br>
Аналогичные 3 вопроса (логин, пароль, адрес) будут заданы и для `nodeny kernel user in mysql` - mysql-юзера
для ядра NoDeny. Соглашаемся с предложениями по умолчанию.<br>
<br>
После этого скрипт создаст структуру папок, скопирует необходимые файлы на их места дислокации, выдаст
соответствующие права и сообщит:<br>
<br>
NoDeny has been Installed. OK!<br>
<br>
Как видим, кроме клавиши `enter` никакие другие не были использованы.<br>
<br>
<br>





<b><a name='startweb'>Тестовый вход в Web-интерфейс</a></b>, открываем в браузере:<br>
<br>
<em>http://10.0.0.2/cgi-bin/adm/adm.pl</em><br>
<br>
В результате получаем приглашение залогиниться в системе. Если ранее при создании логина bill_www
установили пароль отличный от указанного в примере, то перед приглашением будет выведено сообщение
о неудачной попытке соединиться с базой данных - это нормально.<br>
<br>
Поскольку в базу не внесено ни одной учетной записи администратора, необходимо залогиниться под
системным логином. По умолчанию это логин: <em>admin</em>, а пароль к нему: <em>hardpass</em>.
Если залогиниться не удается - читаем <a href='FAQ.html#noauth'>здесь</a> и <a href='work.html#eraccess'>здесь</a>.<br>
<br>
После процедуры логина попадаем либо на титульную страницу либо, если при создании логина bill_www указали иной пароль,
на страницу изменения настроек системы NoDeny. Во втором случае в окне настроек слева в меню выбираем раздел
&#171;Базы Данных&#187;, после чего в поле для пароля БД вводим пароль, который указали для юзера bill_www.
Заодно устанавливаем &#171;ключ для кодирования паролей в базе данных&#187; на этой же странице.
Ставим галочку над кнопкой &#171;сохранить&#187; и нажимаем эту кнопку. Ниже сообщения об успешности записи
конфига выводится ссылка &#171;Создать учетную запись администратора&#187;, нажимаем ее, сейчас необходимо создать учетную запись
суперадминистратора, после чего вернуться к редактированию конфига. Перед созданием читаем о
<a href="priv.html">привилегиях администраторов</a>.<br>
<br>

Попасть в меню привилегий администраторов также можно через &#171;Операции&#187; &rarr; &#171;Привилегии администраторов&#187;.
Выбираем &#171;Добавить нового&#187;, заполняем поля &#171;логин&#187;, &#171;пароль&#187; и &#171;имя&#187;, выбираем &#171;создать&#187;.
В меню выбираем &#171;список администраторов&#187; и видим в списке запись единственного администратора,
причем в заблокированном состоянии. Выбираем ссылку &#171;привилегии&#187;. В появившемся окне нажимаем на ссылку
&#171;Отметить все&#187; либо ставим галочки напротив каждой привилегии, попутно читая описание к ней.
Напротив &#171;Запрет на изменение личных настроек&#187; галочку не ставим.
Запись считается суперадминистративной если стоят галочки напротив &#171;Редактирование настроек NoDeny&#187; и
&#171;Редактирование учетных записей администраторов&#187;. Тем не менее, все остальные
привилегии имеют силу. Признак &#171;суперадминистратор&#187; дает возможность разрулить критические ситуации в биллинге.<br>
<br>
Пора прощаться с системным логином - выбираем в верхнем меню &#171;Авторизация&#187; и логинимся под только что созданной записью
суперадминистратора.<br>
<br>
<br>
<br>




<b><a name='safe'>Безопасность.</a></b><br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
ee /usr/local/etc/apache22/httpd.conf
</pre>
</div><br>
<br>

Для включения HTTPS, перемещаем курсор в конец конфига и раскомментируем строку:

<div class='code'><div class='mark'>строка файла httpd.conf</div><pre>
Include etc/apache22/extra/httpd-ssl.conf
</pre>
</div>
<br>

и добавляем такие:<br>
<br>
<div class='code'><div class='mark'>вставляем в файл httpd.conf</div>
<pre>
&lt;Directory "/usr/local/www/apache22/cgi-bin/adm/"&gt;
    SSLRequireSSL
&lt;/Directory&gt;
</pre>
</div>
<br>


SSLRequireSSL разрешает доступ к /usr/local/www/apache22/cgi-bin/adm/ только по
шифрованному соединению (https).<br>
<br>
Для работы по протоколу https необходим сертификат, который можно сгенерировать самому:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
mkdir /usr/local/etc/apache22/ssl
chmod 700 /usr/local/etc/apache22/ssl
cd /usr/local/etc/apache22/ssl
openssl genrsa -out server.key -rand randfile -des3 2048
</pre>
</div>


здесь будет запрошен пароль для сертификата, вводим `1111`, учитывая,
что через несколько шагов от него избавимся.<br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
openssl req -new -x509 -key server.key -out server.crt -days 365
</pre>
</div>

здесь 365 - количество дней работы сертификата.<br>
<br>

Избавимся от пароля в сертификате:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
openssl rsa -in server.key -out server.key
</pre>
</div> 

вводим `1111`.<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
chmod 400 server.key
</pre>
</div>


Настройка ssl-конфига:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
ee /usr/local/etc/apache22/extra/httpd-ssl.conf
</pre>
</div>


Исправляем пути к сертификатам:<br>
<br>
<div class='code'><div class='mark'>Редактируем файл httpd-ssl.conf</div><pre>
SSLCertificateFile "/usr/local/etc/apache22/ssl/server.crt"
SSLCertificateKeyFile "/usr/local/etc/apache22/ssl/server.key"
</pre>
</div>

Рестартуем apache:
<div class='code'><div class='mark'>Команда bash</div><pre>
apachectl restart
</pre>
</div>

и открываем в браузере: https://10.0.0.2/<br>
<br>
Если не получаем приветствующего сообщения &#171;It works!&#187; - смотрим логи:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
tail /var/log/httpd-error.log
</pre>
</div>
<br>



<b><a name='admtune'>Продолжаем настройку NoDeny через Web-интерфейс.</a></b><br>
<br>
Идем по ссылкам меню &#171;Операции&#187; &rarr; &#171;Настройки&#187; &rarr; &#171;Группы клиентов&#187;
&rarr; &#171;Новая группа&#187;. На этом этапе необходимо определиться на какие группы стоит условно разделять
наших клиентов. Автор настоятельно рекомендует создать группу &#171;Удаленные&#187; для хранения учетных
записей, которые разорвали договора. Поскольку такие записи не должны &#171;мешаться под ногами&#187;, то
при создании группы ставьте галку напротив &#171;Не отображать группу в обычном списке клиентов&#187;, а
также &#171;При переходе на новый месяц не производить снятие денежных средств&#187;.<br>
<br>
При создании групп заполнение всех полей не обязательно, фактически достаточно только названия и разрешения
доступа администраторам к данной группе - смотрим колонку справа.<br>
<br>
Технические данные по потокам, ip-адресам и т.д. пока можно не трогать - в будущем успеем это сделать.<br>
<br>
Автор рекомендуем разделить клиентов по географическим районам. Например, внесем группы &#171;Левобережный 1&#187;,
&#171;Левобережный 2&#187; и &#171;Левобережный 3&#187;. В будущем, возможно, у вас будет каждый отдельно взятый
сервер обслуживать свой район. В таком случае будет достаточно указать, что такой-то сервер должен обслуживать
такие-то группы клиентов.<br>
<br>
<br>
В &#171;Операции&#187; &rarr; &#171;Настройки&#187; &rarr; &#171;Улицы&#187; добавим улицы районов
обслуживания, либо любую одну улицу если не терпится побыстрей настроить тарификацию:<br>
<br>

&#171;Операции&#187; &rarr; &#171;Тарифы&#187;. При первом входе в данный пункт меню, будет выведено
100 сообщений о создании 100 тарифов. Количество тарифов указывается в главных настройках, по умолчанию 100.
Все тарифы будут свободными, т.е неопределены. О неопределенности тарифа говорит пустое название. Таким образом,
достаточно тарифу дать название и его уже можно использовать. Внизу страницы выберите свободный тариф под номером 1.
На самом деле, номер тарифа абсолютно неважен, кроме первого, поскольку он будет использоваться по умолчанию, то
мы создадим пакет &#171;Заблокирован&#187;. Этот тариф мы будем назначать удаленным клиентам. Дело в том, что у любой
клиентской записи, даже если она заблокирована, в обязательном порядке имеется пакет тарификации.
Для удаленных клиентов мы будем использовать пакет тарификации стоимостью 0 грн (руб, $), а также предоплаченным трафиком 0 мб.
Даем тарифу название &#171;Заблокирован&#187; и ставим галки напротив:<br>
<br>
- если у клиента выбран данный пакет, то клиент не может заказать автоматическую смену пакета в следующем месяце;<br>
- у клиентов данного пакета почтовый ящик должен быть заблокирован;<br>
- основной тариф. Для удобства тарифы с этим флагом будут идти вначале списка;<br>
- доступ должен быть заблокирован всегда.<br>
<br>
В колонке справа ставим галки напротив всех отделов, по умолчанию отдел всего один: &#171;Офис&#187;. Сохраняем
тариф.<br>
<br>
Создадим административный пакет для самих себя: нулевая стоимость, неограниченный трафик, неограниченная скорость.
Выбираем второй свободный пакет, даем название, скажем, &#171;АДМИН&#187;, предоплаченный трафик направления номер 1
устанавливаем в значение `!` (ставим единственный символ &#171;восклицательный знак&#187;), в поле стоимости превышения
вводим 1. В правой колонке ставим галку напротив нашего отдела, сохраняем тариф.<br>
<br>
Остальные тарифы пока рано создавать т.к. необходимо подготовить схему по которой будет происходить тарификация трафика,
этим займемся когда будем настраивать учет трафика.<br>
<br>
<br>
Создаем тестового клиента с административным пакетом: &#171;Операции&#187; &rarr; &#171;Новый клиент&#187;.<br>
<br>
<br>
<br>
<br>




<b><a name="kernel">Установка ядра NoDeny</a></b> - файл <b>nodeny.pl</b>, должен быть постоянно запущенным.<br>
<br>
Ядро NoDeny соединяется с базами данным своим персональным логином <b>bill_kernel</b>, скрипт инсталляции должен
был создать этот логин.<br>
<br>
В файле <em>/usr/local/nodeny/nodeny.cfg</em> изменяем параметры соединения с базами данных: пароль и адреса баз данных,
если отличаются от указанных в примере. Все остальные параметры конфигурации ядро получит из базы данных после старта.<br>
<br>

Перед запуском ядра важно чтобы в БД находился конфигурационный файл. Однако, если все настраивали четко по инструкции,
т.е. не меняли переменные NoDeny - значит конфига еще нет в БД. В меню &#171;Операции&#187; &rarr; &#171;Настройки&#187;
&rarr; &#171;Администрирование&#187; изменяем, к примеру, параметр &#171;Название сети&#187; и нажимаем кнопку сохранения.<br>
<br>


Запускаем ядро в тестовом режиме:<br>
<br>
<div class='code'><div class='mark'>Команды bash</div><pre>
cd /usr/local/nodeny
perl nodeny.pl -v -nowait
</pre>
</div>
<br>

Результат запуска смотрим на экране. В ssh клиенте типа putty в настройках переключаем консоль в режим win 1251 (Cyrillic)
т.к. лог ведется в кириллице. Если ядро не прекратило работу с выводом ошибки - все ок, прерываем по Ctrl+C и запускаем
в фоновом режиме:<br>
<br>
<div class='code'><div class='mark'>Команды bash</div><pre>
mv rc.d/nodeny.sh /usr/local/etc/rc.d/
/usr/local/etc/rc.d/nodeny.sh
</pre>
</div>
<br>


<br>
Также лог запуска смотрим в &#171;Платежи&#187; &rarr; &#171;Система&#187;. На данном этапе пока не интересуемся
снятием статистики трафика, ее обработкой и т.д., этим займемся после настройки фаервола, агентов авторизации и доступа.<br>
<br>
<br>
<br>


<b><a name="agents">Установка агентов авторизации и доступа.</a></b><br>
<br>
Коротко, агент - это скрипт, который выполняет определенные действия
для конкретной группы клиентов. Как минимум, нам необходимы два действия: авторизация абонентов, а также
регулирование параметров доступа (разрешать/блокировать/шейпить/ограничивать трафик) в зависимости от условий.<br>
<br>
Поскольку наша задача настроить все на одном сервере, то настройка агентов значительно упрощается.
<a href="satellite.html">Детальная информация по агентам</a> понадобится при настройке распределенной системы,
в данный момент пропускаем. Заходим в &#171;Операции&#187; &rarr; &#171;Настройки&#187; &rarr; &#171;Сателлиты&#187; и
выбираем в меню слева &#171;Новый сателлит&#187;. Появляется шаблон для создания конфигурации сателлита. Сателлит -
это сервер, обслуживающий определенный район или группу клиентов. В нашем случае у нас всю сеть будет обслуживать
один сервер, поэтому сателлит будет один. В поле &#171;Логин сателлита&#187; вводим &#171;bill_kernel&#187;. Остальные параметры
нас пока не интересуют - ими займемся когда будем тюнинговать систему либо разделять сеть на сателлиты. Сохраняем конфиг.<br>
<br>
Стандартно в /usr/local/nodeny/ копируются следующие файлы:<br>
<br>
<pre>
noserver.pl	- агент доступа
nofire.pl	- скрипт управления фаерволом
nol2auth.pl	- агент L2-авторизации
nocheck.pl	- скрипт проверки настроек
sat.cfg		- конфигурационный файл
nosat.pl	- вспомогательный модуль, используемый агентами
</pre>

Если при установке мы использовали стандартные пароли, то sat.cfg не трогаем, в противном случае меняем в нем
переменную $Db_pw.<br>
<br>
Проверим, что мы нигде не ошиблись, запуском:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
perl nocheck.pl
</pre>
</div>
<br>

После успешного прохождения тестов, <b>запускаем скрипт L2-авторизации</b>
если вы собираетесь ее использовать. NoDeny поддерживает и другие виды авторизаций,
например, быстро проверить возможность правильной отработки авторизации можете через
web-авторизацию в клиентской статистике.<br>
<br>


В отладочном режиме:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
perl nol2auth.pl -v
</pre>
</div>

либо в фоновом:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
perl nol2auth.pl &amp;
</pre>
</div>
<br>

Пробуем авторизоваться с помощью программы авторизатора, после чего смотрим в Web-админку в список клиентов - обозначается
ли как авторизованная необходимая клиентская запись: возле нее должно выводится изображение ключика определенного цвета
в зависимости от режима авторизации. Не забывайте, что ядро должно быть запущено всегда. Без него клиент будет
проходить авторизацию, однако в БД он не будет обозначен авторизованным, поскольку ядро проводит дополнительные проверки
и может изменить режим авторизации, скажем на &#171;авторизован, но доступ заблокирован по денежной задолженности&#187;.<br>
<br>

Если авторизация не проходит, а в отладочном режиме nol2auth.pl работает без ошибок, проверяем  прохождение пакетов
на клиентском интерфейсе:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
tcpdump -iem1 -p -n udp port 7723
</pre>
</div>
<br>

и выясняем приходят ли пакетики от клиента, а также уходят ли они к нему, причем уходят именно с того
адреса на который пришли (если вдруг вы решили поэксперементировать с настройкой системы). Не блокирует
ли фаервол эти пакеты?<br>
<br>
<br>
<br>


<b>Установка агента доступа</b> задача посложнее - поскольку он управляет фаерволом, то сперва настроим его.<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
mv rc.firewall /etc/
ee /etc/rc.firewall
</pre>
</div>
<br>

и в одной из первых строк меняем<br>
<br>

<div class="code">ifOut='em0'</div>

на имя интерфейса, который смотрит в "сторону интернета".<br>
<br>

В предложенном /etc/rc.firewall правила обеспечивают:<br>
<br>
- доступ по ssh к серверу;<br>
- доступ к Web-статистике и админке NoDeny по tcp-портам 80 и 443;<br>
- обслуживание DNS-запросов клиентов внутренней сети (предполагается, что на текущем маршрутизаторе запущен DNS-сервер);<br>
- обслуживание l2-авторизации (авторизаторы NoDeny) клиентов внутренней сети;<br>
- отправку трафика в коллектор его учета (правила с divert);<br>
- разрешение доступа в интернет только разрешенных авторизованных клиентов, по требованию агента доступа noserver.pl.<br>
<br>


Если сервер не перегружался, т.е. правила не сформированы, то запускаем вручную:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
sh /etc/rc.firewall
</pre>
</div>
<br>

Если получаем сообщение об ошибке примерно такое:<br>
<br>
<div class='coment'>ipfw: getsockopt(IP_FW_ADD): Invalid argument</div>
<br>

- ядро не скомпилировано с опцией IPDIVERT, не страшно - подгрузим как модуль ядра:<br>
<br>
<div class='code'><div class='mark'>Команды bash</div><pre>
kldload ipdivert.ko
sh /etc/rc.firewall
</pre>
</div>
<br>

rc.firewall должен запускаться при старте системы, поэтому:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
echo firewall_enable=\"YES\" &gt;&gt; /etc/rc.conf
</pre>
</div>
<br>

<br>
Для трансляции &#171;серых&#187; адресов в &#171;белые&#187; необходим NAT. Будем использовать pf nat:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
ee /etc/pf.conf
</pre>
</div>
<br>

<div class='code'><div class='mark'>Вставляем  в файл pf.conf</div><pre>
set limit states 128000
set optimization aggressive
nat pass on em0 from 10.0.0.0/8 to any -&gt; em0
nat pass on em0 from 192.168.0.0/16 to any -&gt; em0
</pre>
</div>

Обязательно вместо em0 укажите внешний интерфейс сервера, т.е тот, который смотрит с сторону провайдера.
В это же значение должна быть установлена переменная ifOut в файле /etc/rc.firewall!<br>
<br>


<div class='code'><div class='mark'>Команда bash</div><pre>
pfctl -N -f /etc/pf.conf
</pre>
</div>
<br>

и если получаем сообщение:<br>
<br>
<div class='coment'>pfctl: /dev/pf: No such file or directory</div><br>

то подгрузим pf как модуль ядра и добавим в автозагрузку:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
kldload pf.ko
pfctl -N -f /etc/pf.conf
pfctl -e
echo pf_load=\"YES\" &gt;&gt; /boot/loader.conf
echo pf_enable=\"YES\" &gt;&gt; /etc/rc.conf
</pre>
</div>

<br>

<a name="collector">В фаерволе предусмотрено, что трафик будет отправляться в коллектор</a>, для его подсчета. В NoDeny есть возможность
использования <a href='collectors.html'>разных коллекторов</a>. К примеру возьмем ipcad, который присутствует в портах:<br>
<br>
<div class='code'><div class='mark'>Команды bash</div><pre>
cd /usr/ports/net-mgmt/ipcad && make install clean
echo ipcad_enable=\"YES\" &gt;&gt; /etc/rc.conf
</pre>
</div>
<br>

По умолчанию, в конфиге <em>/usr/local/etc/ipcad.conf</em> много комментариев и несколько лишних настроек, удалим все
и создадим &#171;с нуля&#187;:<br>
<br>

<div class='code'><div class='mark'>Редактируем ipcad.conf</div><pre>
capture-ports enable;
interface divert port 1 netflow-disable;
interface divert port 2 netflow-disable;
rsh enable at 127.0.0.1;
rsh root@127.0.0.1 admin;
rsh ttl = 3;
rsh timeout = 30;
dumpfile = ipcad.dump;
chroot = /tmp;
memory_limit = 50m;
</pre>
</div>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
ipcad -d
</pre>
</div>
<br>
<br>



Запускаем агент доступа:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
perl noserver.pl &amp;
</pre>
</div>
<br>

Авторизуемся с помощью программы-авторизатора либо включаем режим &#171;всегда онлайн&#187; у одной из клиентских записей
и через несколько секунд:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div><pre>
ipfw table 10 list
</pre>
</div>
<br>
видим в списке этот ip. Теперь пробуем получать доступ в интернет только при авторизации и только когда учетная запись
незаблокирована. 
<br>
<br>
<br>
<br>

<b>Автозапуск агентов с запуском системы.</b><br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
cp /usr/local/nodeny/rc.d/* /usr/local/etc/rc.d/
</pre>
</div>
<br>
<br>
<br>
<br>



<b><a name="tunedb">Тюнинг.</a></b><br>
<br>


В системе FreeBSD с RAM большей 1 Гб рекомендуется в <em>/boot/loader.conf</em> добавить строки:<br>
<br>
kern.maxdsiz="1G"<br>
kern.dfldsiz="1G"<br>
<br>
что увеличит максимальный размер процесса до 1 Гб, в противном случае сервер mysql будет использовать
лишь 512 Мб. При наличии 4 Гб памяти под процессы можно выделить 2G.<br>
<br>

Для сервера с ядром так же желательно увеличить этот параметр до 1 Гб для тех случаев, когда
в настройках раздела &#171;ядро&#187; вы указали большое количество записей в кеше адресов.
Кеш адресов позволяет увеличить скорость обсчета трафика. Однако, вы должны учитывать тот факт,
что эффективность кеша адресов обычно довольно низкая, если учитывать затраты памяти на увеличение
скорости обсчета. Если у вас нет недостатка в оперативной памяти, вы можете увеличить кеш-адресов,
скажем до 2 млн. записей, соответственно повысив максимальный размер процесса как было указано выше.<br>
<br>

<br>
Детализация трафика наиболее затратная по объему занимаемой информации.
Ориентировочно на каждые 25 млн записей в сутки (это до 5 тысяч абонентов) таблица имеет
размер примерно гигабайт. При  работе с такими объемами рекомендуется увеличить буфер
для ключей, в /etc/my.cnf сервера дополнительной базы данных в секции [mysqld]:<br>
<br>
key_buffer = 1000M<br>
<br>
где 1000M объем выделяемой оперативной памяти, автор установил в это значение при общем объеме
RAM 2 Гб. Обратите внимание, что увеличение размера буфера ключей делаем только для
дополнительной БД.<br>
<br>
В том же конфиге и в основной и дополнительной БД добавляем/изменяем:<br>
<br>
max_connections=500<br>
<br>
т.е. увеличим максимально возможное количество одновременных соединений с mysql. Дело в том, что
в момент наступления нового месяца запускается скрипт, который проводит снятия со счетов абонентов,
обнуляет трафик и выполняет др. сервисные функции. В этот период любопытство клиентов достигает
максимального уровня и большое их количество открывает Web-статистику дабы выяснить, что же произошло
с их счетом. При этом организуется большое количество соединений с mysql, что может негативно сказаться
на работоспособности скрипта &#171;перехода на новый месяц&#187;. Значение 500 подобрано для сети с
20 тыс абонентов и имеет значительный запас.<br>
<br>
<br>
В конфиге mysql дополнительной БД закомментируйте строку:<br>
<br>
log-bin=<br>
<br>
что отключит ведение логов всех запросов. К сожалению, по опыту автора, не всегда бинарный лог
отключается таким способом, поэтому приходится вставлять в конфиг дополнительную директиву:<br>
<br>
binlog-ignore-db=bill<br>
<br>
<br>
Для администраторов, желающих "поковырять" БД, чтобы понять на нижнем уровне структуру БД, рекомендуем
установить утилиту <a href="other.html#phpmyadmin">phpMyAdmin</a> администрирования СУБД mysql.<br>
<br>
<br>



<b>Важно!</b><br>
<br>
Все процессы NoDeny привязаны ко времени на сервере основной базы данных. Если время на определенном сервере
иное, то за основу все равно берется время из основной БД. Установка неправильного времени крайне нежелательна
т.к. очевидно, что трафик должен регистрироваться в точное время. Особенно важно, что тарификация во многом
привязана к дню месяца - это день начала потребления услуг, начало нового месяца и др. Во избежание
проблем, установите в crontab периодическую синхронизацию времени с сервером времени:<br>
<br>
27  */4   *    *     *    /usr/sbin/ntpdate time.windows.com > /dev/null 2>&1<br>
<br>
- синхронизация будет происходить каждые 4 часа в 27 минут. Обратите внимание, что это решение
&#171;для ленивых&#187; - лучше синхронизировать более правильными средствами.<br>
<br>
<br>

<br>
<br>
<br>
<br>
<br>
<br>
<br>
</body>
</html>
