<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - Install</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>
<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Агенты NoDeny</b></td>
</tr></table>

<br>
<br>
<b>Понятие сателлит</b><br>
<br>


В то время как ядро NoDeny обрабатывает информацию, необходимо параллельно
обеспечить авторизацию клиентов и управление доступом в интернет (ресурсам и т.д).<br>
<br>


Этим занимаются <b>агенты</b> - скрипты, которые запускаются на сервере, обслуживающем определенную категорию
клиентов, обычно по географическому признаку. Вероятно, ваша сеть начиналась с простейшего решения: один маршрутизатор,
по одну сторону локальная сеть, по другую - провайдер. Все управление (нат, шейпы и т.д) осуществлялось на этом
единственном сервере. По мере роста, появилась необходимость расширения парка маршрутизаторов, например, по
географическому признаку - один обслуживает район А, другой - Б. Сервер, на котором запускается хотя бы один
агент называем <em>сателлитом</em>.<br>
<br>

Для каждого сателлита в базе данных NoDeny формируется своя конфигурация, которую агенты загружают
при старте. Интересной особенностью сателлита является то, что имеется возможность дать доступ 
скриптам-агентам только к определенной группе (группам) клиентов. Это призвано повысить безопасность
на случай если будет взломан один из сателлитов. Таким образом не произойдет полной утечки информации.<br>
<br>

<em>Агент авторизации</em> гарантирует, что клиенты, претендующие на получение услуг <em>в данный момент времени</em>,
являются <em>легальными абонентами</em>, т.е. исключает махинации с подменой данных.<br>
<br>

<em>Агент доступа noserver.pl</em> предназначен для управления трафиком клиентов на основе требуемых критериев: авторизации,
пакета тарификации, времени суток и т.д.<br>
<br>

Агенты, как и все остальные узлы системы, взаимодействуют с ядром через базу данных, работают независимо
(вообще, необязателен запуск любого из них), но используют общий конфиг <em>sat.cfg</em>, в котором прописаны параметры
соединения с основной базой данных. После соединения из базы запрашивается персональный конфиг для требуемого агента.<br>
<br>



<b>Параметры соединения с БД.</b><br>
<br>
В распределенной системе, состоящей из нескольких разбросанных серверов авторизации и управления, в каждой точке
запускается своя копия скрипта(ов). Каждый сателлит соединяется с БД по уникальному логину со своими правами.
Уникальность логина рекомендуется автором. Например, автор для своих серверов назначает логины для коннекта к БД
в виде bill_название_сервера, например bill_stone либо bill_linkom_gate1 (логин для сервера gate1 сети linkom).<br>
<br>
Создав в основной базе данных и базе авторизаций логин для нужного сервера, необходимо дать права на доступ
<em>только к необходимым таблицам</em>, не больше, не меньше. Это требование очень важно т.к. базируется
на давно известном факте, что любая система может быть взломана. Особенно это
актуально в разбросанных по масштабной сети серверах, которыми управляют разные администраторы с разными
способностями и лояльностью. Таким образом, потеря контроля над одним сервером не должна быть причиной утечки
ВСЕЙ информации, в худшем случае только ее части, которую обслуживает данный сервер.<br>
<br>
Последнее требование может быть выполнено только при условии ограниченного доступа логина к таблицам БД.
У логина определенного сателлита должны быть следующие привилегии в БД bill:<br>
<br>
INSERT в таблицу dblogin<br>
INSERT в таблицу sat_log<br>
SELECT таблицы conf_sat<br>
SELECT таблицы dopdata<br>
SELECT таблицы nets<br>
SELECT таблицы files<br>
SELECT таблицы plans2<br>
SELECT таблицы users_trf<br>
SELECT таблицы со списком абонентов<br>
<br>
- В <em>dblogin</em> агент авторизации записывает авторизации клиентов, которые потом обрабатываются
ядром NoDeny.<br>
<br>
- Из <em>nets</em> берутся сети, для управления трафиком.<br>
<br>
- В <em>files</em> хранятся сети, которые динамически подгружаются из файлов в биллинг.<br>
<br>
- В <em>plans2</em> хранятся данные пакетов тарификации, в частности параметры скоростей.<br>
<br>
- <em>users_trf</em> периодически обновляется ядром NoDeny такими данными: общий трафик клиента (по всем его ip)
  с учетом перераспределения и оплачиваемых составляющих, баланс клиента с учетом текущих снятий за услуги,
  время посылки последнего сообщения абоненту.<br>
<br>
- В <em>conf_sat</em> содержится конфигурация для агентов текущего сателлита.<br>
<br>
- В таблицу <em>sat_log</em> периодически записывается состояние агента для последующего анализа в модуле мониторинга.<br>
<br>
<br>

Представление users_linkom создается таким образом:<br>
<div class='code'><div class='mark'>команда mysql</div>
CREATE ALGORITHM = UNDEFINED VIEW users_linkom AS SELECT * FROM users WHERE grp IN (18);<br>
</div>
<br>
здесь 18 - это id группы клиентов подразделения linkom. Если сателлитом обслуживается несколько подразделений,
то номера групп перечислите через запятую. Номера групп вы можете посмотреть в настройках в разделе &#171;группы клиентов&#187;.
В результате выполнения указанной команды, таблица users_linkom будет содержать в себе информацию только об абонентах
в группе №18, причем эти данные не будут статическими - изменения в таблице всех клиентов (users)  будут автоматически
затрагивать таблицу users_linkom.<br> 
<br>
После настройки фаерволов на сервере-сателлите и на серверах баз данных (разрешение tcp соединения на порт 3306), а
также конфигурационного файла <em>sat.cfg</em>, вы можете проверить, что не ошиблись в настройке,
путем запуска скрипта noserver.pl с ненулевым параметром, например:<br>
<br>
bash# perl nocheck.pl<br>
<br>
В результате скрипт должен проверить возможность соединения с основной базой данных по указанному логину и
возможность выборки из нужных таблиц.<br>
<br>
Скрипт <em>noserver.pl</em> периодически обращается к базе данных, получает данных о тех клиентах, которым по
заданным условиям необходимо разрешить доступ, после этого передает скрипту <em>nofire.pl</em> ip-адрес с
дополнительными параметрами для более тонкого регулирования доступа.<br>
<br>
<img src='../i/noserver1.gif'><br>
<br>
Такими параметрами являются:<br>
<br>
- режим авторизации клиента (&#171;вкл&#187;, &#171;город&#187;, &#171;выкл&#187;, &#171;авторизован, но исчерпан лимит&#187;
и др);<br>
- номер пакета авторизации;<br>
- &#171;дополнительные параметры&#187;, которые прописаны администратором в учетной записи клиента;<br>
- скорости, указанные в пакете тарификации.<br>
<br>
Как только <em>noserver.pl</em> &#171;увидит&#187;, что один из этих параметров изменился, то поступает таким образом:
сначала посылает указание <em>nofire.pl</em> отключить заданный ip и сразу же включить, но с новыми параметрами.<br>
<br>
&#171;Как только увидит&#187; требует пояснения. Поскольку скрипт периодически соединяется с базой данных, то он
&#171;видит&#187; обновления не чаще указанного периода. Естественно, чем меньше этот период, тем выше реакция агента
на события. Уменьшение периода обновления данных клиентов уменьшает инерционность скрипта, но увеличивает
нагрузку на базу данных. Необходимо выдерживать баланс т.к. очевидно, что ничего страшного не произойдет,
если администратор заблокирует доступ клиенту, а доступ ему заблокируется не мгновенно, а через 5 или 10 секунд.<br>
<br>
Итак, периодически осуществляется запрос к базе &#171;покажи мне кто авторизован&#187;,
после чего происходит сравнение данных с теми, которые были получены в предыдущий запрос к базе:<br>
<br>
- если клиент в предыдущий запрос не был авторизован, то включаем его;<br>
- если данные клиента предыдущего запроса отличаются от текущих - клиента выключаем и сразу включаем.<br>
<br>
После обработки всех авторизованных, анализируются данные предыдущего среза - кто был авторизован на тот момент, но
не оказался в списке текущих включенных клиентов - эти ip &#171;выключаются&#187;.<br>
<br>
Кроме того, периодически проверяется изменились ли тарифы т.к. их данные (скорости) также могут быть изменены.
Период проверки тарифов иной. Изменение:<br>
<br>
- состояния доступа открыт/закрыт;<br>
- состояния авторизации (включение/переключение авторизатора);<br>
- &#171;дополнительных параметров&#187; в учетной записи;<br>
- номера пакета тарификации;<br>
<br>
&#171;проявится&#187; в фаерволе максимум через количество секунд указанное как &#171;период обновления данных клиентов&#187;.
Изменение данных пакета &#171;проявится&#187; максимум через время равное произведению указанного периода на количество периодов
для полного обновления, например 300 секунд рекомендует автор.<br>
<br>


<b>Последовательность действий при установке скриптов доступа и/или авторизации на сателлит:</b><br>
<br>
1) Определяемся какие группы клиентов будет обслуживать текущий настраиваемый сателлит - в админке NoDeny смотрим в разделе
&#171;Операции&#187; &rarr; &#171;Настройка&#187; &rarr; &#171;Группы клиентов&#187; номер(а) необходимых групп;<br>
<br>
<b>На сервере основной БД:</b><br>
<br>
2) Создаем таблицу, которая будет производной от таблицы клиентов, однако будет содержать данные клиентов
только выбранных групп:<br>
<br>
<div class='code'><div class='mark'>команда mysql</div>
CREATE ALGORITHM = UNDEFINED VIEW users_linkom AS SELECT * FROM users WHERE grp IN (5,6,8);
</div>
<br>

где 5,6,8 - номера групп. Группа с номером 0 означает &#171;без группы&#187;.<br>
<br>
3) 
Создаем в mysql логин для настраиваемого сервера и выдаем соответствующие права;
<div class='code'><div class='mark'>команды mysql</div>
CREATE USER 'bill_stone'@'10.2.3.4' IDENTIFIED BY 'hardpass';<br>
GRANT USAGE ON *.* TO 'bill_stone'@'10.2.3.4' IDENTIFIED BY 'hardpass';<br>
GRANT INSERT ON `bill`.`dblogin` TO 'bill_stone'@'10.2.3.4';<br>
GRANT INSERT ON `bill`.`sat_log` TO 'bill_stone'@'10.2.3.4';<br>
GRANT SELECT ON `bill`.`dopdata` TO 'bill_stone'@'10.2.3.4';<br>
GRANT SELECT ON `bill`.`conf_sat` TO 'bill_stone'@'10.2.3.4';<br>
GRANT SELECT ON `bill`.`nets` TO 'bill_stone'@'10.2.3.4';<br>
GRANT SELECT ON `bill`.`files` TO 'bill_stone'@'10.2.3.4';<br>
GRANT SELECT ON `bill`.`users_trf` TO 'bill_stone'@'10.2.3.4';<br>
GRANT SELECT ON `bill`.`plans2` TO 'bill_stone'@'10.2.3.4';<br>
GRANT SELECT ON `bill`.`users_linkom` TO 'bill_stone'@'10.2.3.4';<br>
</div>
здесь:<br>
<br>
&nbsp;&nbsp;<em>10.2.3.4</em> - ip сателлита;<br>
&nbsp;&nbsp;<em>bill_stone</em> - создаваемый логин для доступа агентов в БД;<br>
&nbsp;&nbsp;<em>hardpass</em> - пароль этого логина;<br>
&nbsp;&nbsp;<em>users_linkom</em> - виртуальная таблица, специально созданная для группы клиентов linkom - скажем, у нас биллинг
обслуживает несколько городских сетей, одна из которых имеет название linkom.<br>
<br>
<br>
<b>В админке NoDeny:</b><br>
<br>
4) Создаем конфигурацию для текущего сателлита в разделе &#171;Операции&#187; &rarr; &#171;Настройка&#187; &rarr; &#171;Сателлиты&#187;.
Идентификатор сателлита - это логин с которым происходит соединение агентов сателлита с базами данных, в данном случае bill_stone.<br>
<br>
<b>На сервере-сателлите:</b><br>
<br>
5) Устанавливаем клиента mysql: <b>mysql-client-5.0</b><br>
<br>
6) Устанавливаем модуль <b>p5-DBD-mysql</b>, который при установке из портов установит <b>perl</b>;<br>
<br>
<br>
<b>Далее, если настраиваем <em>noserver.pl</em>:</b><br>
<br>
7) Редактируем <em>sat.cfg</em> и запускаем <em>noserver.pl</em> с командой проверки:<br>
<br>
bash# perl nocheck.pl<br>
<br>
8) Если скрипт не смог соединиться с БД или выполнить sql-запрос: проверяем фаервол как на текущем сервере так и
на сервере основной БД, логин и пароль соединения, права доступа к соответствующим таблицам. Пробуем соединиться
с сервером mysql с консоли;<br>
<br>
9) Проверяем корректную работу <em>noserver.pl</em>:<br>
<br>
в папку с этим скриптом устанавливаем тестовый <em>nofire.pl</em> (из папки <em>Satellites/TEST.OK</em> поставки)
и запускаем скрипт управления доступом:<br>
<br>
bash# perl noserver.pl<br>
<br>
<em>Тестовый nofire.pl</em> не управляем фаерволом, а просто выводит сообщения на экран какой ip и с какими параметрами
(режим авторизации и пакет) скрипт <em>noserver.pl</em> указывает включить или отключить в фаерволе.<br>
<br>
Отключайте/включайте в админке доступ, разрешайте доступ без авторизации/с авторизацией, меняйте пакет тарификации, после
чего смотрите вывод скрипта. Скрипт при стандартной настройке реагирует на изменение от 0 до 10 секунд. Т.е. вы должны
убедиться, то при установке режима &#171;клиент без авторизации&#187; происходит включение абонента (скрипт выводит сообщение
&#171;<em>ON: ip_клиента доп_параметры</em>&#187;), при изменении ключевых параметров (пакета тарификации клиента, дополнительных
параметров) происходит отключение ip, затем сразу включение. Убедитесь, что скрипт реагирует на вывод клиента из
обслуживаемой группы (должен отключить все включенные ip клиента), реагирует на включение/выключение доступа через админку,
реагирует на изменение авторизации клиентов.<br>
<br>
Если в обслуживаемой группе слишком много абонентов, то для исключения большого количества отладочной информации, временно
создайте новую группу и переместите в нее тестируемых абонентов.<br>
<br>
Не забывайте, что поведение скрипта описывается в конфигурации сателлита через админку, например вы можете указать, что клиенты
авторизованные в режиме &#171;сеть&#187; не принимаются во внимание при разрешении доступа, либо же доступ будет открываться
всем незаблокированным клиентам в независимости от авторизации. Все зависит от ваших требований.<br>
<br>
10) <a href="firewall.html">Настраиваем фаервол.</a><br>
<br>
11) Анализируем скрипт <em>nofire.pl</em> в стандартной поставке. Вы должны подстроить его и свой фаервол под свои требования.<br>
<br>
12) запускаем <em>noserver.pl</em> в фоновом режиме:<br>
<pre>
bash# perl noserver.pl &
</pre>
<br>
и проводим последнюю проверку.<br>
<br>
13) Организуем автозагрузку агента доступа, например так:<br>
<br>
<pre>
bash# cd /usr/local/nodeny/
bash# chmod 700 go_noserver.sh
bash# ee /etc/rc.local

вписываем:

cd /usr/local/nodeny/
nohup ./go_noserver.sh &
</pre>
<br>
<br>
<b>Если же настраиваем агента авторизации <em>nol2auth.pl</em>:</b><br>
<br>
7) Устанавливаем модуль шифрования <b>p5-Crypt-Rijndael</b>;<br>
<br>
8) Редактируем параметры соединения с БД в файле <em>sat.cfg</em>;<br>
<br>
9) Запускаем агент авторизации:<br>
<br>
<div class='code'><div class='mark'>команда bash</div>
perl nol2auth.pl &amp;
</div>
<br>
<br>
<br>
<br>
<br>
</body>
</html>
