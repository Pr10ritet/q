<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - Пример установки FreeBSD 6.1</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>
<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Пример установки FreeBSD</b></td>
</tr></table>
<br>



Данная инструкция представляют собой &#171;заметки на полях&#187; и рекомендации в очень сжатом
виде, которые вы вправе не принять, а настроить систему исходя из своих знаний и соображений. 
Этот документ не поможет вам установить FreeBSD, если ранее вы этого не делали - читайте
соответствующие книги/статьи. Более того, необходимо учитывать, что информация актуальна
на момент написания документации и в настройке системы со временем могут могут появиться отличия.
Вообще, в последнее время FreeBSD стала значительно дружелюбней, так что автору иногда приходится
выкидывать куски документации - все меньше и меньше тонкостей и проблем возникает при работе
с FreeBSD.<br>
<br>



<b>1. Подбор объема HDD</b><br>
<br>
Объем HDD подбирается исходя из выполняемых сервером задач. Наиболее требовательны к объемам
дискового пространства сервера под базы данных, все остальные узлы NoDeny (ядро, шлюз, сервер
администрирования) имеют минимальные требования т.к будут хранить фактически только операционную
систему.<br>
<br>

Расходы на базы данных определяются в основном параметрами сохранения трафика - чем больше детализации
и чем дольше она хранится, тем, естественно, бОльшие затраты дисковой памяти. Под детализацией
понимается полное сохранение всех обращений клиентов на каждый ip адрес в интернете. Эта
информация вспомогательная т.к предназначена для разруливания спорных ситуаций, но
очень &#171;жадная&#187; к ресурсам. Вы можете вообще отказаться от детализации, тогда вам надолго хватит
скромного по современным меркам винчестера (10-20 Гб на сеть из нескольких тысяч человек).<br>
<br>
Ориентировочно, детализация трафика для 1000 абонентов требует примерно 200-300 Мб дискового пространства в сутки.
При подборе дискового массива учитывайте, что детализацию обычно не требуется хранить очень долго, например,
2-3 месяца вполне достаточно.<br>
<br>
Если в вашей системе планируется разделение баз данных на основную и дополнительную - не забывайте, что статистика
трафика, в том числе детализированная, сохраняется только в дополнительной базе данных. Поэтому для основной базы
данных нет необходимости использовать HDD больших объемов. С запасом хватит даже 10Гб.<br>
<br>
Для баз данных больших сетей рекомендовано использование аппаратных рейд-контроллеров.<br>
<br>
<br>



<b>2. При установке</b> системы для сервера БД, учитывайте, что базы mysql будут находиться в разделе /var,
поэтому бОльшую часть дискового пространства отведите ему. Не устанавливайте никакие пакеты (apache и т.д) -
пакеты часто обновляются и вы установите устаревший вариант. Кроме того, рекомендуем устанавливать
все из портов (/usr/ports) т.к. там хорошо работает система зависимостей, т.е. при установке
требуемого пакета автоматически будут установлены все, от которых данный зависит. Более того,
update производится также с зависимостями.<br>
<br>
После установки системы (после первой перезагрузки) залогиньтесь под root-ом и настройте
rc.conf (если забыли настроить сетевые параметры при установке):<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
ee /etc/rc.conf
</div>
<br>

(<em>ee</em> - удобный редактор, пришедший на замену трудновоспринимаемому <em>Vi</em>)<br>
<br>

<div class='code'><div class='mark'>Редактирование rc.conf</div><pre>
ifconfig_fxp0="inet 10.0.0.2 netmask 255.255.225.0"
hostname="nodeny.com.gg"
defaultrouter="10.0.0.1"
sshd_enable="YES"
firewall_enable="YES"

fsck_y_enable="YES"
background_fsck="NO"
</pre></div>
<br>

background_fsck="NO" отключает проверку дисков в бекграунде, для серверов лучше это сделать при старте,
fsck_y_enable="YES" говорит "yes" на все вопросы при проверке.<br>
<br>

Если вы настраиваете шлюз, то добавьте:<br>
<br>
<div class='code'><div class='mark'>Редактирование rc.conf</div>
gateway_enable="YES"
</div>
<br>

<div class='code'><div class='mark'>Команда bash</div>
ee /etc/rc.firewall
</div>
<br>


<div class='code'><div class='mark'>Редактирование rc.firewall</div><pre>
#!/bin/sh -
f='/sbin/ipfw'
${f} add 100 allow ip from any to any
</pre></div><br>
<br>

DNS-сервер:<br>
<br>
<div class='code'><div class='mark'>Команда bash</div>
ee /etc/resolv.conf
</div>
<br>

<div class='code'><div class='mark'>Редактирование resolv.conf</div><pre>
nameserver      10.0.0.1
</pre></div>
<br>

Делаем <em>reboot</em> либо применяем сетевые параметры без перезагрузки: <em>/etc/netstart</em>.
Пока будущий сервер загружается, переключаем монитор на рядом стоящий компьютер с настроенной
графической оболочкой и ssh клиентом. Заходим по ssh на настраиваемый сервер.<br>
<br>

<br><b>Обновляем систему:</b><br>
<br>

<div class='code'><div class='mark'>Команды bash</div>
<pre>
freebsd-update fetch
freebsd-update install
</pre>
</div>

<br><b>Обновляем дерево портов:</b><br>
<br>

<div class='code'><div class='mark'>Команда bash</div><pre>
portsnap fetch
</pre>
</div>
<br>

<br><b>Компилируем ядро</b> пока загружается дерево портов, запускаем еще один ssh и:<br>
<br>

<div class='code'><div class='mark'>Команды bash</div><pre>
cd /usr/src/sys/i386/conf/
cp GENERIC NODENY
ee NODENY
</pre>
</div>

<div class='code'><div class='mark'>Редактирование файла NODENY. В конце дописываем</div><pre>
options         IPFIREWALL
options         IPDIVERT
options         IPFIREWALL_FORWARD
options         DUMMYNET
</pre></div>
<br>
<br>


В FreeBSD 7.x планировщик SCHED_ULE :<br>
<br>

<div class='code'><div class='mark'>Редактирование файла NODENY</div><pre>
options         SCHED_ULE</pre>
</div>
<br>
<br>



Если есть желание облегчить ядро - убираем все упоминания о SCSI, IPV6, принтере, SLIP и т.д.
Не перестарайтесь - в будущем это оборудование у вас может появится, в частности не комментируйте
дорогие сетевые карты, возможно в скором времени они у вас появятся. Рекомендуем отключить все
ISA-сетевые, их век безвозвратно ушел.<br>
<br>

Трудно представить, что для биллинга у вас будут устаревшие типы процессоров, поэтому комментируем:<br>
<br>
<div class='code'><div class='mark'>Редактирование файла NODENY</div><pre>
#cpu            I486_CPU
#cpu            I586_CPU
</pre></div>
<br>
<br>

<div class='code'><div class='mark'>Команды bash</div>
<pre>
config NODENY
cd ../compile/NODENY
make depend
make
make install
</pre>
</div>

<br>
Пока компилируется ядро, возвращаемся к первому окну с ssh-сессией и смотрим закончилась ли загрузка
дерева портов, как только она завершится:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
<pre>
portsnap extract
</pre>
</div>

Перезагружаемся с новым ядром. Коннектимся по ssh и ставим:<br>
<br>
<div class='code'>
<pre>
/usr/ports/shells/bash  
/usr/ports/misc/mc-light
/usr/ports/ports-mgmt/portupgrade
/usr/ports/net/trafshow
/usr/ports/net/mtr
</pre>
</div>

стандартной последовательностью:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
cd /usr/ports/shells/bash && make install clean
</div>
<br>

После установки bash, назначаем его дефолтным для своей учетной записи:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
pw usermod efendy -s /usr/local/bin/bash
</div>
<br>

Не ставьте пакеты параллельно т.к. у них могут быть общие зависимости. 
Для экономии времени загрузки с интернета вы можете во время компиляции пакета для других выполнить
<em>make fetch</em> - только загрузка исходников. Еще большая экономия времени будет при
установке скомпиленных паккаджей, но они есть не на все пакеты. <em>mtr</em> лучше компилить так:
<em>make -DWITHOUT_X11 install clean</em> - не будут устанавливаться модули для работы в &#171;иксах&#187;. Либо:<br>
<br>

<div class='code'><div class='mark'>Команда bash</div>
ee /etc/make.conf
</div>
<br>


<div class='code'><div class='mark'>Редактирование make.conf</div><pre>
WITHOUT_X11=yes
WITHOUT_GUI=yes
WITHOUT_IPV6=yes
</pre>
</div>
<br>
<br>


<b>В будущем</b> всегда следите за безопасностью вашего сервера: держите порты в актуальном состоянии (portsnap, portupgrade),
закройте сервисы для доступа &#171;из мира&#187; (к примеру оставьтся &#171;в мир&#187; только 22й порт),
не устанавливайте шлюз и файловый/видео/samba архив сети (тем более хостинг) на одном компьютере - это неудобно и
небезопасно. Регулярно просматривайте логи.<br>
<br>
<br><br>

Не забывайте, что система для повышения производительности должна &#171;тюнинговаться&#187;. В разделе настройки
фаервола указано какие параметры sysctl стоит подкрутить. По совету админов крупных сетей, попробуйте установить
драйверы на сетевые карты em &#171;от Yandex&#187;, на момент написания документации находились 
<a href='http://people.yandex-team.ru/~wawa/'>здесь</a>.<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>




</body>
</html>
