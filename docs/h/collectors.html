<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - Install</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>
<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Настройка учета трафика</b></td>
</tr></table>
<br>
<br>
Регистрацией трафика занимаются внешние программы, называемые коллекторами трафика. NoDeny может работать с разными,
каждый из существующих коллекторов имеет как преимущества так и недостатки. Вам важно понять какой наиболее подойдет
вашим требованиям. Дадим краткую характеристику по каждому.<br>
<br>

<b>ipcad</b> - надежен, по статистике автора не `вылетал` ни разу. Имеет несколько вариантов сбора статистики.
Недостаток - выполняется в userland. Тем не менее, уменьшение производительности в допустимых пределах.<br>
<br>

<a href='netflow.html'>netflow-коллектор</a>. Многие `несофтовые` решения могут экспортировать статистику по netflow.
Сенсор работает на уровне ядра, что положительно сказывается на производительности.<br>
<br>

<a href='ipacct.html'>ng_ipacct</a> работает в ядре, т.е производителен. Недостатком является `забор` трафика не по
сети, а с помощью консольной утилиты, из-за чего в NoDeny пока не реализовано удаленное снятие статистики, хотя и есть
соображения по этому поводу.<br>
<br>


Коллектор постоянно регистрирует проходящий через маршрутизатор трафик, а ядро NoDeny время от времени запрашивает
у коллектора эти данные, потом обрабатывает и распределяет по клиентам.<br>
<br>
В данном документе будет описана настройка коллектора ipcad, предварительно полезно изучить
<a href='kernel.html#ipcad'>как NoDeny работает с ipcad.</a><br>
<br>
При проектировании  системы вы должны были решить на каких серверах будут установлены коллекторы трафика.
Пойдем от простого к сложному и сначала рассмотрим вариант &#171;все на одном сервере&#187;:<br>
<br>
bash# cd /usr/ports/net-mgmt/ipcad && make install clean<br>
<br>
В конфигурационном файле <em>/usr/local/etc/ipcad.conf</em> можно настроить:<br>
<br>
1) Способ, которым коллектор будет получать данные о трафике. Для нас интересны 2 варианта:<br>
<br>
- ipcad самостоятельно ведет учет трафика, проходящего через определенный интерфейс(ы) системы;<br>
- ipcad ведет учет трафика, который мы ему укажем путем посылки этого трафика из фаервола на порт ipcad.<br>
<br>
В первом случае параметр <em>interface</em> должен указывать на имя интерфейса системы:<br>
<br>
<em>interface em1;</em><br>
<br>
Во втором случае мы должны указать номер порта, на который следует посылать трафик из фаервола:<br>
<br>
<em>interface divert port 111 netflow-disable;</em><br>
<br>
- в приведенном примере ipcad будет &#171;слушать&#187; порт 111 и считать все полученные пакеты.<br>
<br>
Проще всего использовать первый способ, однако он обладает одним серьезным недостатком - в этом
случае ipcad учитывает весь пришедший на интерфейс трафик, даже если он (трафик) фаерволом
будет заблокирован. Что бы вы уловили суть проблемы, приведем пример: заблокированный
клиент постоянно посылает в интернет запросы (специально либо это вирусы), этот трафик будет
зарегистрирован ipcad, однако не будет пропущен в интернет т.к. ip заблокирован. 
Получится, что исходящий трафик будет постоянно начисляться клиенту - ведь клиент действительно
формирует исходящий трафик. Однако мы не должны начислять этот трафик, поскольку он не отправлен
в интернет. Забегая вперед, успокоим, что решить эту проблему можно - очевидно, что полезный
трафик должен быть двунаправленным: послали запрос, получили ответ. Следовательно, если есть исходящий
трафик, а входящий равен нулю - можно считать, что обмена трафиком не было. В NoDeny есть параметр,
указывающий не считать исходящий трафик если нет входящего.<br>
<br>
Тем не менее, автор предпочитает использовать второй, более управляемый вариант, когда ipcad считает строго
тот трафик, который был отправлен и получен. В разделе <a href='firewall.html'>настройка фаервола</a> представлены
схемы, где показано в каком месте в цепочке прохождения трафика мы считаем (отправляем в коллектор)
этот трафик: при выходе пакетов из фаервола в пункт назначения.<br>
<br>
2) Опция <em>capture-ports</em> включает/отключает сбор статистики не только &#171;какой Ip на какой Ip
посылал сколько байт&#187;, но и по портам и протоколам. Таким образом, имеется возможность оценивать
трафик не только по объему, но и по его типу. Например, возможно выделить категорию &#171;WWW-трафик&#187;
и засчитывать в нее трафик идущий на порт 80, весь остальной трафик считать другой категорией.
Даже если вам не требуется разделять трафик по направлениям основанных на портах, возможно вы пожелаете
вести детальную статистику по всем портам.<br>
<br>
<em>capture-ports enable;</em> включает статистику по портам и протоколам. Обратите внимание, что при этом
возникает несколько отрицательных моментов:<br>
<br>
- объем передаваемой информации увеличивается в несколько раз, что предъявляет дополнительные требования
к каналу, если ipcad запускается на удаленном сервере;<br>
- увеличение объема увеличивает время обработки данных ядром NoDeny;<br>
- увеличивает потребление памяти ipcad, хотя в текущее время это некритично.<br>
<br>
Кроме того, вы должны учитывать, что при серьезных сканированиях, а также вирусных эпидемиях, идет
перебор большого количества портов, для каждого создается отдельная строка в статистике - это значительно
увеличит нагрузку и на канал и на ядро NoDeny. Поэтому крайне рекомендуется воспользоваться агрегированием -
когда группа портов в статистике будет отображаться под одним номером. Например порты с 1..79 будут
считаться портом 0, 80й будет считаться 80м, 81..65535 - тоже нулевым, таким образом мы выделим трафик
на порт 80 (www), а любой другой сагрегируем.<br>
<br>
На начальном этапе настройте сокращенную статистику: <em>capture-ports disable;</em><br>
<br>
3) <em>rsh enable at 127.0.0.1;</em><br>
<br>
- на адресе 127.0.0.1 будет запущен rsh-сервер, принимающий соединения. Через этот сервер статистика будет
"забираться" ядром NoDeny.<br>
<br>
4) <em>rsh root@127.0.0.1 admin;</em><br>
<br>
- разрешаются rsh-соединения пользователя root с сервера 127.0.0.1.<br>
<br>
5) <em>memory_limit = 50m;</em><br>
<br>
- установили лимит памяти выделенной для ipcad в 50 Мб.
<br>
<br>
Упрощенная настройка описана в разделе инсталяции NoDeny <a href='install.html#collector'>здесь</a>.<br>
<br>
<br>
<b>При настройке удаленного ipcad</b>, rsh необходимо запускать уже не только на локальном адресе, но и на внешнем,
а также разрешить коннекты с сервера NoDeny. Например, ядро запускается на сервере 10.1.1.1, коллектор на сервере 10.1.1.2,
конфиг этого коллектора:<br>
<pre>
capture-ports disable;
interface em1;
rsh enable at 127.0.0.1;
rsh enable at 10.1.1.2;
rsh root@10.1.1.1 admin;
rsh root@127.0.0.1 admin;
rsh ttl = 6;
rsh timeout = 30;
dumpfile = ipcad.dump;
chroot = /tmp;
memory_limit = 50m;
</pre>
- rsh-сервер запускается на адресах 127.0.0.1 и на 10.1.1.2, последний для того, чтобы сервер 10.1.1.1 мог получать
статистику трафика.<br>
<br>
Не забудьте правильно настроить фаервол на запрет коннектов с других, отличных от 10.1.1.1, ip - это повысит безопасность
системы.<br>
<br>
В настройках NoDeny, в разделе &#171;Коллекторы трафика&#187; укажите в списке коллекторов адрес 10.1.1.2, удалив при этом
127.0.0.1, если, конечно, не требуется снимать статистику и с этого коллектора.<br>
<br>
Параметр &#171;Сети клиентов, для которых будет учитываться трафик&#187; указывает, какой коллектор ответственен
за какую сеть клиентов. В зависимости от проектирования вашей сети, возможны такие ситуации, когда пакет, идущий
к/от клиента, проходит более чем через один сервер с коллектором трафика. Например, трафик идущий от
клиента в одном районе к клиенту в другой район. Считаем что в каждом районе стоит свой маршрутизатор, на котором
запущен свой коллектор. В таком случае этот трафик будет зафиксирован обоими коллекторами и, следовательно, начислен дважды,
что не есть правильно.<br>
<br>
Конечно, если вы не собираетесь учитывать трафик между абонентами распределенной сети, а регистрируете только
интернет-трафик, то эта проблема вас не коснется, поскольку интернет-трафик попадает к клиенту, пройдя
всего один маршрутизатор с коллектором. В этом случае, сколько бы у вас не было серверов с коллекторами,
вы можете указать в параметре &#171;Сети клиентов, для которых будет учитываться трафик&#187; в левой колонке
значение &#171;0.0.0.0/0&#187;, а в правой - &#171;*_*&#187;<br>
<br>



<a name="sym">Последнее означает следующее</a>: трафик любого клиента (0.0.0.0/0) учитывать в каком бы коллекторе он не встретился (*_*).<br>
<br>
Звездочка перед символом подчеркивания означает &#171;любой коллектор&#187;, а после - &#171;любой интерфейс сервера&#187;.
Вместо звездочки, перед символом подчеркивания, может стоять число, указывающее на номер коллектора в списке
коллекторов. При этом трафик идущий на/от клиента в заданной сети будет засчитат клиенту только если он
появится в коллекторе с указанным номером.<br>
<br>



<br>Для чего &#171;выдуман&#187; этот параметр? На самом деле, вам он может и не понадобиться никогда. А, возможно,
без него не сможете осуществить задуманное. Чтобы понять суть проблемы, которая привила к появлению этого параметра,
написана целая <a href='localtraf.html'>статья</a>.<br>
<br>



Допустим, необходимо считать трафик между клиентами. Клиентская сеть 10.1.2.0/24 подключена к серверу с ip 10.1.2.1, на котором
запущен коллектор трафика ipcad. Допустим в настройках указано 3 коллектора, 10.1.2.1 по счету 3й. Поэтому в
параметре &#171;Сети клиентов, для которых будет учитываться трафик&#187;  указываем в левой колонке <em>10.1.2.0/24</em>,
а в правой - <em>3_*</em>. К примеру, клиент 10.1.2.100 скачивает файл от клиента с адресом 10.2.2.100 - в результате
сведения о трафике появятся как в коллекторе 10.1.2.1, так и в коллекторе 10.2.2.1. Однако трафик идущий к клиенту
10.1.2.100 будет засчитан только с его &#171;родного&#187; коллектора 10.1.2.1.<br>
<br>
Как было сказано ранее, в большинстве случаев настройка сетей заключается во внесении всего одной строки: 0.0.0.0/0 = *_*.
Для того чтобы удостовериться &#171;хватит&#187; ли вам такой настройки, вы должны подумать может ли оплачиваемый трафик когда-либо
для каких-либо клиентов &#171;проходить&#187; более чем через один коллектор. Возможно, не для всех клиентских сетей есть
необходимость в привязке к номеру коллектора.<br>
<br>
Еще более тонкая настройка может быть осуществлена после символа подчеркивания, где указывается интерфейс. Как упоминалось
ранее, при <em>capture-ports enable;</em> ipcad в статистику вписывает название интерфейса, на котором он
посчитал текущий трафик. Когда ipcad получает данные из фаервола, то в качестве интерфейса будет указан номер порта,
который &#171;слушает&#187; ipcad.<br>
<br>
Примеры:<br>
<br>
2_em1 - интерфейс em1 коллектора №2;<br>
*_em0 - интерфейс em0 любого коллектора;<br>
3_ng* - любой интерфейс ng, например ng1, ng2, ng3 (и т.д). коллектора №3;<br>
*_321 - трафик полученный через порт 321 любого коллектора.<br>
<br>
Последний пример интересен тем, что вы можете на разных серверах указывать один и тот же номер порта, вернее оперировать номерами
как угодно: на одних серверах одинаковые, на других разные, в зависимости от требований. Например у вас два PPPoE-сервера,
к обоим могут подключаться клиенты из одной логической сети (что, правда, не совсем корректно), скажем 10.10.0.0/16. Если
коллекторы установлены на обоих серверах, то не получится одним номером указать, что статистика может учитываться
и с первого и со второго коллектора. Поэтому мы настраиваем ipcad на прослушивание порта 777 на обоих серверах (на других
серверах порты должны быть другими) и в настройках указываем:<br>
<br>
<em>10.10.0.0/16 = *_777</em><br>
<br>
<br>
<br>
Если ipcad настроен на сокращенный вывод, то интерфейс не подлежит проверке - будет проигнорирован. Также вы можете
на разных серверах использовать разную настройку коллекторов - на одном сокращенный вывод, на другом полный.<br>
<br>
<br>
<b>Агрегирование</b> трафика один из способов сократить объем обрабатываемых данных, т.е снизить затраты ресурсов.
Суть заключается в том, то если по некоторым направлениям вам не нужна детализация по ip, скажем, в нашей сети
нигде не используется подсеть 192.168.0.0/16 и нам неважно на какие ip в этой сети будут идти запросы, то мы можем
любой ip от 192.168.0.0 до 192.168.255.255 считать как будто это ip 192.168.0.0. В самом деле, нам не важно на какой
именно адрес был послан запрос в несуществующую сеть, нам важно чтобы при сканировании (вирусном/хакерском) этой сети 
не возникло много тысяч бессмысленных строк. Нам важно знать общий трафик и что он был отправлен в сеть 192.168.0.0/16.<br>
<br>
По-простому, агрегирование это объединение диапазона ip в один ip. Приведем еще один реальный пример. К сети подключена
школа, в которой несколько сотен компьютеров в диапазоне 10.255.0.0/24. Школа - один клиент, который оплачивает трафик всех
компьютеров, не обращая внимания на то, сколько же трафика потребил каждый конкретный компьютер. Т.е необходимости
заводить в NoDeny несколько сотен ip адресов нет - нам не нужно знать трафик каждого. Поэтому коллектор трафика
был настроен на агрегирование сети 10.255.0.0/24, т.е на выходе статистики любой ip был виден как 10.255.0.0, этот ip
и был занесен в NoDeny.<br>
<br>
Для снижения нагрузки возможно появится необходимость в агрегировании, однако не забывайте, что сети, в которые попадают
ваши клиенты не должны подвеграться агрегации, иначе мы теряем информацию о конкретном ip клиента. Например, наша сеть
10.33.0.0/16. Мы можем добавить в конфиг ipcad следующее:<br>
<br>
<pre>
aggregate 10.33.0.0/16 strip 32;
aggregate 10.0.0.0/8 strip 8; 
</pre>
- первая строка указывает на то, что сеть 10.33.0.0/16 не должна агрегированться - strip 32 указывает урезать ip маской /32
(255.255.255.255), т.е фактически не урезать.<br>
<br>
- вторая строка указывает урезать ip в сети 10.0.0.0/8 до значения 10.0.0.0 - strip 8  указывает урезать маской /8
(255.0.0.0).<br>
<br>
как вы заметили учитывается порядок следования записей об агрегации, поскольку сеть 10.33.0.0/16 является частью
сети 10.0.0.0/8.
<br>
<br>
</body>
</html>
