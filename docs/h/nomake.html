<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - nomake.pl</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>
<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Скрипт создания конфигурационных файлов nomake.pl.</b></td>
</tr>
</table>

<div class='mainbody'>
<br>

Скрипт nomake.pl предназначен для формирования конфигурационных файлов для программ, которым необходимы
данные NoDeny. К примеру, dhсp-серверу необходимо предоставить список соответствий ip = mac для каждого
клиента.<br>
<br>


nomake.pl работает как сателлит, т.е. для него в меню &#171;операции&#187; &rarr; &#171;настройки&#187;
&rarr; &#171;сателлиты&#187; необходимо создать конфиг.<br>
<br>

Для работы nomake.pl использует шаблон, по которому формирует выходной файл, например, используем
в качестве шаблона example1.txt:<br>
<br>
<div class="code"><div class="mark">команда bash</div>
perl nomake.pl example1.txt
</div>
<br>

Если в шаблоне нет ошибок, то скрипт останется в запущенном состоянии и будет периодически перезаписывать
заданный выходной файл в случае, если какие-либо данные изменились.<br>
<br>

В шаблоне задаются команды в виде тегов по типу html:<br>
<br>

<div class="code"><div class="mark">содержимое example1.txt</div>
<pre>
&lt;file&gt;example1.conf&lt;/file&gt;

hello. All NoDeny users:

&lt;filtr&gt;
&lt;lat_login&gt; = &lt;ip&gt;
&lt;/filtr&gt;
</pre></div>


Тег file задает имя выходного файла, это обязательный тег.<br>
<br>

Тег filtr указывает, что фрагмент внутри него будет растиражирован для каждого клиента, для
которого будет выполнено условие. В примере условие не указано (об условиях будет сказано ниже).
Фильтры важны, поскольку обычно конфиги состоят из общих и персональных данных.
В примере строка `hello. All NoDeny users:` - это общие данные, она будет вставлена в выходной
файл example1.conf всего один раз, а данные внутри блока filtr будут скопированы для
каждого клиента:<br>
<br>
<div class="code"><div class="mark">содержимое example1.conf</div>
<pre>
hello. All NoDeny users:

login1 = 10.0.0.2
login2 = 10.0.0.8
login3 = 10.0.0.9
login4 = 10.0.1.5
</pre></div>
<br>


В тексте шаблона конфига необходимо экранировать спецсимволы &lt; или &gt; путем вставки перед ними
символа `\`, например:<br>
<br>
<div class="code">
<pre>
\&lt; &lt;lat_login&gt; = &lt;ip&gt; \&gt;
</pre></div>

приведет к формированию конфига вида:<br>
<br>
<div class="code"><div class="mark">содержимое example1.conf</div>
<pre>
&lt; login1 = 10.0.0.2 &gt;
&lt; login2 = 10.0.0.8 &gt;
&lt; login3 = 10.0.0.9 &gt;
&lt; login4 = 10.0.1.5 &gt;
</pre></div>
<br>

В качестве тегов, указывающих на данные клиента, nomake воспринимает:<br>
<br>
<pre>
ip	  - ip адрес;
login	  - логин;
lat_login - логин, сконвертированный в латиницу;
pass	  - пароль;
state	  - состояние доступа (on/off);
auth	  - режим авторизации (no/on/ong/off/1/2/3...).
</pre>
<br>

Доступ к дополнительным данным осуществляется через префикс `dopdata-`, после которого
идет название (точнее алиас - смотри настройки дополнительных полей) поля. Например:<br>
<br>

<div class="code"><div class="mark">пример шаблона</div>
<pre>
&lt;file&gt;test.conf&lt;/file&gt;
&lt;reload&gt;/usr/local/etc/rc.d/isc-dhcpd restart&lt;/reload&gt;

Users in 10.0.0.0/24:
&lt;filtr net='10.0.0.0/24'&gt;
login: &lt;login&gt;, mac: &lt;dopdata-_mac&gt;
&lt;/filtr&gt;

Users in 10.0.1.0/24:
&lt;filtr net='10.0.1.0/24'&gt;
login: &lt;login&gt;, speed: &lt;dopdata-_speed_in&gt;
&lt;/filtr&gt;
</pre></div>

Здесь `dopdata-_mac` указывает, что в данном месте конфига будет вставлено значение дополнительных
данных клиентов, которое имеет имя (алиас) _mac. Обратите внимание на фильтры - в примере их 2:<br>
<br>

сначала будет выведен список соответствий логин/mac для сети 10.0.0.0/24, потом список
логин/входящая скорость для сети 10.0.1.0/24.<br>
<br>

В теге reload (необязательный) задается команда, которая будет выполнена после того как nomake
(пере)создаст конфиг. nomake мониторит изменение данных клиентов, после чего перезаписывает
конфиг и вызывает команду тега reload - в данном примере рестарт dhcp-сервера.<br>
<br>
Условий может быть несколько:<br>
<br>

<div class="code"><div class="mark">пример шаблона</div>
<pre>
&lt;file&gt;test2.conf&lt;/file&gt;

Users in 10.0.0.0/24:
&lt;filtr net='10.0.0.0/24' state='^on$'&gt;
login: &lt;login&gt;, mac: &lt;dopdata-_mac&gt;
&lt;/filtr&gt;
</pre></div>

В примере конфиг формируется только для клиентов в сети 10.0.0.0/24 и у которых доступ не заблокирован.<br>
<br>

<div class="code"><div class="mark">формат фильтров</div>
<pre>
&lt;filtr поле1='условие' поле2='условие' поле3='условие'&gt;
</pre></div>

Обратитие внимание, что условие обязательно должно быть в одинарных кавычках. Если в условии необходимо
использовать такую кавычку - экранируйте ее символом `\`. Условие представляет собой регулярное выражение,
например:<br>
<br>

<div class="code">
<pre>
&lt;filtr dopdata-_mac='^..:..:..:..:..:..$' state='^on$'&gt;
</pre></div>

проверяет, что мак-адрес задан верно, т.е. включает шесть пар символов, разделенных двоеточием. Также проверяется,
что поле state равно `on`. Символы `^` и `$` указывают на начало и конец строки. Это стандартный механизм
регулярных выражений т.к. 'on' будет соответствовать любой строке, содержащей построку `on`, например,
`stone`.<br>
<br>

При тестировании используйте ключ `v`, что приведет к выводу отладочных сообщений на экран:<br>
<br>

<div class="code"><div class="mark">команда bash</div>
perl nomake.pl -v example2.txt
</div>


</div>
<br><br><br><br>
<br><br><br><br>
<br><br><br><br>
<br><br><br><br>
<br>
<br>
<br>
<br></body>
</html>
