<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Nodeny - Install</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>
<div class='mainbody'>
<table border=0 width=90% class="coment"><tr>
<td><a href="../index.html"><img src="../i/logo.gif" border=0 valign=middle></a></td>
<td align=center><b>Биллинговая система NoDeny. Программирование</b></td>
</tr></table>
<br><br><br>

<div class="coment" align=center>Информация для разработчиков</div><br>
<ul>
<li><a href='tables.html#db'>Детальная информация по таблицам БД</a></li>
<li><a href="kernel.html">Ядро NoDeny</a></li>
<li><a href='plugins.html'>Написание плагинов клиентской статистики</a></li>
</ul>
<br> 
<br>
<b>Программирование веб-админки NoDeny</b> (в разработке...)<br>
<br>
<br>
Основные служебные подпрограммы находятся в calls.pl. Обратите внимание, что некоторые подпрограммы
используют глобальные переменные! Так очень часто используется глобальная переменная $dbh.<br>
<br>
<br>
<b>sql_select_line</b> предназначена для выборки одной строки из таблицы БД.<br>
<br>
Вход:<br>
<br>
&nbsp;&nbsp; 0 - ссылка dbh<br>
&nbsp;&nbsp; 1 - sql-запрос<br>
&nbsp;&nbsp; 2 - [комментарий]<br>
&nbsp;&nbsp; 3 - [скрытый запрос]<br>
<br>
Обязательны только параметры 0 и 1. Комментарий будет выведен главному администратору
в специальной области где отображаются все выполняющиеся sql-запросы. Если у администратора
нет прав на просмотр sql-запросов либо он отключил их вывод, то комментарий игнорируется.
Если комментарий выводится, то перед sql-запросом. Если параметр 3 установлен, то вместо
реального sql-запроса выводится этот (3й) параметр. Предназначено для скрытия запросов, 
в которых участвуют пароли. Если комментарий равен 0 (символ `ноль`), то все данные по запросу
будут выведены мелким шрифтом в одну строку.<br>
<br>
<br>
Возврат:<br>
<br>
0 - ссылка fetchrow_hashref или false, если ошибка либо пустая выборка<br>
<br>
Пример:<br>
<br>
<div class='code'>
<pre>
$p=&amp;sql_select_line($dbh,"SELECT unix_timestamp()",'Получим время на сервере БД');
&Error("Не удалось получить время из БД!") unless $p;
$t=$p->{'unix_timestamp()'};
</pre>
</div>
<br>
Либо:<br>
<br>
<div class='code'>
<pre>
$p=&amp;sql_select_line($dbh,"SELECT passwd FROM xxx WHERE id=5",0,'Получим пароль, запрос не показываем');
$passwd=$p? $p->{passwd} : '12345';
</pre>
</div>
<br>
Обратите внимание, что sql_select_line предназначен для выборки только одной строки.
Для выбора нескольких строк используйте:<br>
<br>
<b>sql</b><br>
<br>
Вход: тоже, что и у sql_select_line<br>
<br>
Выход: ссылка на ->execute или false, если ошибка<br>
<br>
<br>
Пример:<br>
<br>
<div class='code'>
<pre>
$sth=&amp;sql($dbh,"SELECT * FROM users",'Получим список всех клиентов');
while ($p=$sth->fetchrow_hashref)
  {
   $OUT.="ip: $p->{ip}&lt;br&gt;";
  }
</pre>
</div><br>
<br>
<br>
<br>
<b>sql_do</b> предназначена для выполнения запросов обновления (INSERT, UPDATE, DELETE).<br>
<br>
Вход: тоже, что и у sql_select_line.<br>
<br>
Выход: количество обновленных строк либо ноль, если ошибка.<br>
<br>
Обратите внимание, что количество обновленных строк может быть равно нулю, но
это не будет означать ошибку, т.е. условию будет соответствовать 0 строк.
Эта ситуация разруливается стандартным методом (придумано не в NoDeny):<br>
<br>
если ошибки нет и обновлено 0 строк, то возвращается значение, которое
НЕ является нулем, однако при сравнении РАВНО нулю. Возможно, это выглядит
как хак, однако это вполне неормально для perl.<br>
<br>

Пример:<br>
<br>
<div class='code'>
<pre>
$rows=&amp;sql_do($dbh,"UPDATE users SET balance=balance-1 WHERE id=1 LIMIT 1");
&amp;Error('Баланс не обновлен, проблема с БД.') unless $rows;
&amp;Error('Баланс не обновлен - клиент с id=1 не найден в БД!') if $rows<1;
&amp;OkMess('Баланс обновлен. Все ок');
</pre>
</div>
<br>
Комментарии:<br>
<br>
Хотя поле id таблицы users является уникальным, мы использовали LIMIT 1.
Это является стилем автора, который вполне логично обосновывается:
операции обновления/удаления являются относительно опасными, поскольку
ошибись программист и не укажи условие или укажи его неправильно -
есть риск обновить/удалить всю таблицу. В данном случае, при ошибке мы
получим обновление только одной строки.<br>
<br>

Условие unless $rows выполняется, когда $rows будет = 0.
Когда обновлено 0 строк, в $rows содержится значение не 0, поэтому
это условие не будет срабатывать. С другой стороны, при стравнении с
единицей $rows будет являться нулем. Т.е. будет выполнено условие $rows&lt;1.<br>
<br>
<br>
<br>


<b>Подпрограммы-фильтры.</b>
<br>
Фильтры предназначены для отсеивания или замены специальных символов
в передаваемых переменных для того чтобы исключить вредное либо непрогнозируемое действие
этих спецсимволов.<br>
<br>

С NoDeny существует 2 вида фильтров: для mysql и для web.<br>
<br>
<br>
Для web:<br>
<br>
<b>Filtr_out</b> фильтрует символы, которые являются управляющими для html.<br>
<br>
Применять всегда, когда необходимо вывести какие-либо данные в html-страницу клиента.<br>
<br>
Пример:<br>
<br>


<div class='code'>
<pre>
$p=&amp;sql_select_line($dbh,"SELECT fio FROM user WHERE id=5");
&amp;Error('Ошибка получения данных клиента') unless $p;
$OUT.='Фамилия клиента: '.&amp;Filtr_out($p->{fio});
</pre>
</div>
<br>
Если не произвести фильтрацию, то после того, как любопытный диспетчер даст клиенту имя
&#171;&lt;h1&gt;Иванов&lt;/h1&gt;&#187;, мы получим вывод его имени большими буквами. Это простейший пример,
а можно еще и javascript ввести...<br>
<br>
<br>
<br> 
<br>
<br>
<br>
<br>
<br>
<br>
</body>
</html>
