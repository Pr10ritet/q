Управление mirkotik, используя его API

Внимание! На данный момент в API mikrotik существуют
кое-какие недостатки из-за которых пришлось разработать не совсем
идеальную схему управления. Будем надеятся, что в будущих версиях
OS Mikrotik-а эти недостатки будут исправлены.

В частности, начиная с версии 3.21, API поддерживает queries, что
устранило бы одну из проблем. Однако у автора на руках имелась
версия 3.20.

Что может скрипт:

1) включение/выключение ip.

2) создание simple queue для ip с указанием скорости RX/TX.

3) модифицирование скорости, если она изменилась:
- абоненту изменили тариф
- изменились скорость в самом тарифе
- установили/изменили/удалили персональную скорость в доп. параметрах клиента

4) синхронизация с Микротиком. Т.е. если пропадет связь/Микротик перезагрузится
и др. ситуации - скрипт будет пытаться синхронизироваться пока не получит на
Микротике то, что желает видеть.

Недостатки и пока нереализованные фичи:

1) Каждый ip имеет персональную скорость, т.е. фича когда все алиасы попадают
в одну трубу, пока не реализована.

2) При изменении ip клиента, старая queue не удаляется, что не влияет на
работу, просто лишняя запись.

3) В сязи с тем, что API имеет недостатки, приходится изменять данные queue
таким образом: add, затем set. Т.е. если queue не существует - срабатывает
команда add, если нет - set изменяет текущие данные. Т.е избыточность в виде
двух действий. Связано с тем, что скрипт ради быстродействия работает в
ассинхронном режиме - он не проверяет результат выполнения каждой
команды, а посылает их потоком. Периодически происходит синхронизация -
скрипт сверяет все ли правила в Микротике соответствует тем, что он посылал.
Если нет, пытается привести их в порядок. Такая схема позволяет избежать
падения производительности при удаленных микротиках, когда время команда-ответ
значительно.



На mikrotik-е создаются следующие фаервольные правила:

ip firewall filter add chain=forward action=accept dst-address-list=goodboys
ip firewall filter add chain=forward action=drop dst-address-list=allboys
ip firewall filter add chain=forward action=accept src-address-list=goodboys
ip firewall filter add chain=forward action=drop src-address-list=allboys
ip firewall filter add chain=forward action=drop 

Для простых случаев - это слегка избыточные правила. Однако они работают
как для простых случаев так и для разруливания ситуаций типа
трафик от разблокированного клиента -> на заблокированного.

Список goodboys - здесь будут клиентские ip, которым разрешен доступ в инет.
allboys - список всех клиентских ip.

Попадание ip в этот список обеспечивается скриптом hw_mikrotik.pl по такой
цепочке:

noserver.pl -> nofire.pl -> hw_mikrotik.pl

Скрипт использует API Микротика, что необходимо включить на Микротике:

ip service enable api